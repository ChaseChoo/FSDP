<!DOCTYPE html>
<html class="light" lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>OCBC ATM - Digital Wallet</title>

  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <link href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
  <script id="tailwind-config">
  tailwind.config = {
    darkMode: "class",
    theme: {
      extend: {
        colors: {
          primary: "#ea2a33",
          "background-light": "#f8f6f6",
          "background-dark": "#211111",
        },
        fontFamily: { display: ["Public Sans", "sans-serif"] },
        borderRadius: { DEFAULT: "0.25rem", lg: "0.5rem", xl: "0.75rem", full: "9999px" },
      }
    }
  }
  </script>
  <style type="text/tailwindcss">
    .material-symbols-outlined {
      font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
      font-size: 32px;
    }
    .tile-card { @apply flex items-center gap-4 bg-primary/5 border border-primary/20 p-4 rounded-xl hover:bg-primary/10 transition-all; }
    .btn-primary { @apply bg-primary text-white px-6 py-2 rounded-lg font-bold hover:bg-red-700 transition-colors; }
    .btn-secondary { @apply bg-zinc-200 dark:bg-zinc-700 px-4 py-2 rounded-lg hover:bg-zinc-300 dark:hover:bg-zinc-600 transition-colors; }
    .card { @apply bg-white dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 rounded-xl shadow-sm; }

    /* Exchange Rate Info Card */
    .exchange-info {
      margin-top: 1rem;
      padding: 1.25rem;
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
      border: 2px solid #0ea5e9;
      border-radius: 0.75rem;
      display: none;
      animation: slideDown 0.3s ease-out;
    }
    .exchange-info.show {
      display: block;
    }
    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .exchange-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1rem;
      padding-bottom: 0.75rem;
      border-bottom: 1px solid #bae6fd;
    }
    .exchange-title {
      font-weight: 700;
      font-size: 0.95rem;
      color: #075985;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .live-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      background: #10b981;
      color: white;
      padding: 0.25rem 0.6rem;
      border-radius: 9999px;
      font-size: 0.7rem;
      font-weight: 600;
    }
    .pulse-dot {
      width: 6px;
      height: 6px;
      background: white;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.6; transform: scale(0.9); }
    }
    .exchange-details {
      display: grid;
      gap: 0.75rem;
    }
    .exchange-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem;
      background: white;
      border-radius: 0.5rem;
    }
    .exchange-label {
      font-size: 0.85rem;
      color: #64748b;
      font-weight: 500;
    }
    .exchange-value {
      font-size: 0.95rem;
      font-weight: 700;
      color: #0c4a6e;
    }
    .converted-preview {
      font-size: 1.5rem;
      font-weight: 800;
      color: #0ea5e9;
      font-family: 'Courier New', monospace;
    }
    .no-fee-badge {
      background: #dcfce7;
      color: #166534;
      padding: 0.4rem 0.75rem;
      border-radius: 0.5rem;
      font-size: 0.8rem;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
    }
  </style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display text-[#1b0e0e] dark:text-white min-h-screen flex flex-col">

  <!-- Header (matches Home) -->
  <header class="w-full bg-white dark:bg-zinc-900 border-b border-[#f3e7e8] dark:border-zinc-800 px-6 lg:px-12 py-4 sticky top-0 z-50">
    <div class="max-w-[1400px] mx-auto flex items-center justify-between">
      <div class="flex items-center gap-3">
        <a href="home.html" class="cursor-pointer">
          <img src="sources/logo_ocbc.png" alt="OCBC Logo" class="h-8 hover:opacity-80 transition-opacity">
        </a>
      </div>
      <div class="flex items-center gap-3">
        <button onclick="window.location.href='home.html#noncash'" class="bg-primary/10 text-primary px-4 py-2 rounded-lg font-bold text-sm flex items-center gap-2 hover:bg-primary/20 transition-colors">
          <span class="material-symbols-outlined !text-lg">arrow_back</span> Back
        </button>
      </div>
    </div>
  </header>

  <!-- Main layout: content + AI assistant (matches Home) -->
  <main class="flex-1 flex flex-row max-w-[1400px] mx-auto w-full px-6 py-8 gap-8 overflow-hidden">
    <!-- Left: Digital Wallet Transfer -->
    <div class="flex-1 flex flex-col overflow-y-auto pr-2">
      <div class="card p-6 md:p-8 mb-6">
        <div class="flex items-center justify-between mb-4">
          <h1 class="text-2xl md:text-3xl font-extrabold">Digital Wallet Transfer</h1>
          <span class="material-symbols-outlined text-primary">smartphone</span>
        </div>
        <p class="text-zinc-500 dark:text-zinc-400 mb-6">Move funds to Alipay, Weixin Pay, GrabPay, Touch 'n Go or PayNow.</p>

        <!-- Success / Error messages -->
        <div id="successMessage" class="hidden card border-primary/30 p-4 text-sm text-green-700 dark:text-green-300 bg-green-50 dark:bg-green-950/30">Success</div>
        <div id="errorMessage" class="hidden card border-red-300 p-4 text-sm text-red-700 dark:text-red-300 bg-red-50 dark:bg-red-950/30">Error</div>

        <!-- Balance -->
        <div class="card p-5 mb-6">
          <div class="flex items-center gap-3 mb-2">
            <span class="material-symbols-outlined text-primary">savings</span>
            <span class="font-medium">Current Balance</span>
          </div>
          <div id="currentBalance" class="text-3xl font-extrabold text-primary">S$0.00</div>
        </div>

        <!-- Wallet type selection -->
        <div class="mb-6">
          <label class="block font-bold mb-2">Select Wallet Type</label>
          <div class="grid grid-cols-2 sm:grid-cols-3 gap-3">
            <!-- Alipay -->
            <button class="wallet-type-btn tile-card group" data-wallet="alipay">
              <div class="bg-white dark:bg-zinc-800 p-2 rounded-lg group-hover:bg-zinc-100 dark:group-hover:bg-zinc-700 w-12 h-12 flex items-center justify-center">
                <svg viewBox="0 0 120 120" width="40" height="40" xmlns="http://www.w3.org/2000/svg">
                  <defs>
                    <linearGradient id="aliGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                      <stop offset="0%" style="stop-color:#1677FF;stop-opacity:1" />
                      <stop offset="100%" style="stop-color:#0050B3;stop-opacity:1" />
                    </linearGradient>
                  </defs>
                  <rect width="120" height="120" fill="url(#aliGrad)" rx="12"/>
                  <path d="M 35 45 L 45 45 L 45 60 Q 45 70 55 70 L 70 70 L 70 60 Q 70 55 65 55 L 55 55 Q 50 55 50 60 L 50 70 Q 50 80 60 80 L 75 80 L 75 70 Q 75 65 70 65" fill="none" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M 50 45 L 85 45 L 85 75 Q 85 85 75 85 L 50 85" fill="white" opacity="0.2" rx="2"/>
                </svg>
              </div>
              <div class="text-left">
                <p class="font-bold text-sm text-primary">Alipay</p>
                <p class="text-xs text-zinc-500">China</p>
              </div>
            </button>
            <!-- Weixin Pay -->
            <button class="wallet-type-btn tile-card group" data-wallet="wechat">
              <div class="bg-white dark:bg-zinc-800 p-2 rounded-lg group-hover:bg-zinc-100 dark:group-hover:bg-zinc-700 w-12 h-12 flex items-center justify-center">
                <svg viewBox="0 0 120 120" width="40" height="40" xmlns="http://www.w3.org/2000/svg">
                  <defs>
                    <linearGradient id="wxGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                      <stop offset="0%" style="stop-color:#09B83E;stop-opacity:1" />
                      <stop offset="100%" style="stop-color:#078C2C;stop-opacity:1" />
                    </linearGradient>
                  </defs>
                  <rect width="120" height="120" fill="url(#wxGrad)" rx="12"/>
                  <path d="M 60 30 C 75 30 85 38 85 50 C 85 58 80 65 70 68 L 72 80 L 58 72 C 52 72 48 70 45 65 C 35 62 28 54 28 45 C 28 35 38 28 52 28 Z" fill="white"/>
                  <circle cx="40" cy="45" r="2.5" fill="#09B83E"/>
                  <circle cx="62" cy="45" r="2.5" fill="#09B83E"/>
                </svg>
              </div>
              <div class="text-left">
                <p class="font-bold text-sm text-primary">Weixin Pay</p>
                <p class="text-xs text-zinc-500">China</p>
              </div>
            </button>
            <!-- GrabPay -->
            <button class="wallet-type-btn tile-card group" data-wallet="grabpay">
              <div class="bg-white dark:bg-zinc-800 p-2 rounded-lg group-hover:bg-zinc-100 dark:group-hover:bg-zinc-700 w-12 h-12 flex items-center justify-center">
                <svg viewBox="0 0 120 120" width="40" height="40" xmlns="http://www.w3.org/2000/svg">
                  <defs>
                    <linearGradient id="grabGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                      <stop offset="0%" style="stop-color:#FF6000;stop-opacity:1" />
                      <stop offset="100%" style="stop-color:#E55100;stop-opacity:1" />
                    </linearGradient>
                  </defs>
                  <rect width="120" height="120" fill="url(#grabGrad)" rx="12"/>
                  <path d="M 50 35 Q 45 35 45 42 L 45 72 Q 45 78 50 80 L 75 80 Q 82 80 85 75 Q 88 70 88 62 L 88 42 Q 88 35 82 35 Z" fill="white"/>
                  <path d="M 58 45 L 70 45 M 58 57 L 70 57 M 58 69 L 70 69" stroke="#FF6000" stroke-width="2" stroke-linecap="round"/>
                </svg>
              </div>
              <div class="text-left">
                <p class="font-bold text-sm text-primary">GrabPay</p>
                <p class="text-xs text-zinc-500">SEA</p>
              </div>
            </button>
            <!-- Touch n Go -->
            <button class="wallet-type-btn tile-card group" data-wallet="touchngo">
              <div class="bg-white dark:bg-zinc-800 p-2 rounded-lg group-hover:bg-zinc-100 dark:group-hover:bg-zinc-700 w-12 h-12 flex items-center justify-center">
                <svg viewBox="0 0 120 120" width="40" height="40" xmlns="http://www.w3.org/2000/svg">
                  <defs>
                    <linearGradient id="tngGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                      <stop offset="0%" style="stop-color:#0052CC;stop-opacity:1" />
                      <stop offset="100%" style="stop-color:#003A99;stop-opacity:1" />
                    </linearGradient>
                  </defs>
                  <rect width="120" height="120" fill="url(#tngGrad)" rx="12"/>
                  <circle cx="60" cy="60" r="28" fill="white"/>
                  <path d="M 60 45 L 68 58 L 52 58 Z" fill="#0052CC"/>
                  <path d="M 60 75 L 52 62 L 68 62 Z" fill="#0052CC"/>
                  <circle cx="60" cy="60" r="4" fill="#0052CC"/>
                </svg>
              </div>
              <div class="text-left">
                <p class="font-bold text-sm text-primary">Touch 'n Go</p>
                <p class="text-xs text-zinc-500">Malaysia</p>
              </div>
            </button>
            <!-- PayNow -->
            <button class="wallet-type-btn tile-card group" data-wallet="paynow">
              <div class="bg-white dark:bg-zinc-800 p-2 rounded-lg group-hover:bg-zinc-100 dark:group-hover:bg-zinc-700 w-12 h-12 flex items-center justify-center">
                <svg viewBox="0 0 120 120" width="40" height="40" xmlns="http://www.w3.org/2000/svg">
                  <defs>
                    <linearGradient id="paynowGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                      <stop offset="0%" style="stop-color:#0066FF;stop-opacity:1" />
                      <stop offset="100%" style="stop-color:#0050CC;stop-opacity:1" />
                    </linearGradient>
                  </defs>
                  <rect width="120" height="120" fill="url(#paynowGrad)" rx="12"/>
                  <path d="M 45 35 L 75 35 Q 85 35 85 45 L 85 65 Q 85 75 75 75 L 45 75 Q 35 75 35 65 L 35 45 Q 35 35 45 35 Z" fill="white" opacity="0.9"/>
                  <text x="60" y="60" font-size="24" font-weight="bold" fill="#0066FF" text-anchor="middle" font-family="Arial">Ⓟ</text>
                </svg>
              </div>
              <div class="text-left">
                <p class="font-bold text-sm text-primary">PayNow</p>
                <p class="text-xs text-zinc-500">Singapore</p>
              </div>
            </button>
          </div>
        </div>

        <!-- Wallet ID / Phone -->
        <div class="mb-6">
          <label for="walletId" class="block font-bold mb-2">Wallet ID / Phone Number</label>
          <input id="walletId" type="text" class="w-full p-3 border rounded-lg bg-white dark:bg-zinc-900 border-zinc-200 dark:border-zinc-800" placeholder="Enter your wallet ID" value="wallet-12345"/>
        </div>

        <!-- Quick amounts -->
        <div class="mb-6">
          <label class="block font-bold mb-2">Quick Amount Selection</label>
          <div class="grid grid-cols-3 gap-3">
            <button class="quick-amount-btn bg-primary/10 hover:bg-primary/20 p-3 rounded-lg font-bold text-primary" data-amount="10">S$10</button>
            <button class="quick-amount-btn bg-primary/10 hover:bg-primary/20 p-3 rounded-lg font-bold text-primary" data-amount="20">S$20</button>
            <button class="quick-amount-btn bg-primary/10 hover:bg-primary/20 p-3 rounded-lg font-bold text-primary" data-amount="50">S$50</button>
            <button class="quick-amount-btn bg-primary/10 hover:bg-primary/20 p-3 rounded-lg font-bold text-primary" data-amount="100">S$100</button>
            <button class="quick-amount-btn bg-primary/10 hover:bg-primary/20 p-3 rounded-lg font-bold text-primary" data-amount="200">S$200</button>
            <button class="quick-amount-btn bg-primary/10 hover:bg-primary/20 p-3 rounded-lg font-bold text-primary" data-amount="500">S$500</button>
          </div>
        </div>

        <!-- Custom amount -->
        <div class="mb-6">
          <label for="transferAmount" class="block font-bold mb-2">Or Enter Custom Amount</label>
          <input id="transferAmount" type="number" step="0.01" min="0" class="w-full p-3 border rounded-lg bg-white dark:bg-zinc-900 border-zinc-200 dark:border-zinc-800" placeholder="0.00"/>
        </div>

        <!-- Exchange Rate Info Card -->
        <div id="exchangeInfo" class="exchange-info">
          <div class="exchange-header">
            <div class="exchange-title">
              <span class="material-symbols-outlined !text-lg">currency_exchange</span>
              <span id="exchangeInfoTitle">Exchange Rate Information</span>
            </div>
            <div class="live-badge">
              <div class="pulse-dot"></div>
              LIVE
            </div>
          </div>
          <div class="exchange-details">
            <div class="exchange-row">
              <span class="exchange-label">Exchange Rate</span>
              <span class="exchange-value">1 SGD = <span id="rateValue">5.3500</span> <span id="targetCurrencyCode">CNY</span></span>
            </div>
            <div class="exchange-row">
              <span class="exchange-label">You're sending</span>
              <span class="exchange-value">S$<span id="sgdAmount">0.00</span></span>
            </div>
            <div class="exchange-row">
              <span class="exchange-label">Recipient gets</span>
              <span class="converted-preview">
                <span id="conversionSummary">S$0.00 = ¥0.00</span>
                <span class="sr-only" aria-live="polite"><span id="convertedSymbol">¥</span><span id="convertedAmount">0.00</span></span>
              </span>
            </div>
            <div class="exchange-row">
              <span class="exchange-label">Transfer Fee</span>
              <span class="no-fee-badge">
                <span class="material-symbols-outlined !text-sm">check_circle</span>
                NO FEES
              </span>
            </div>
            <div style="margin-top: 0.5rem; padding: 0.5rem; background: white; border-radius: 0.5rem; font-size: 0.75rem; color: #64748b; text-align: center;">
              Rate updates every 5 minutes • Last updated: <span id="rateUpdateTime">now</span>
            </div>
          </div>
        </div>

        <!-- Actions -->
        <div class="flex flex-col sm:flex-row gap-3">
          <button id="transferBtn" class="btn-primary w-full sm:w-auto">Transfer Now</button>
          <button class="btn-secondary w-full sm:w-auto" onclick="window.location.href='/home.html'">Back to ATM</button>
        </div>
      </div>
    </div>

    <!-- Right: AI Chat Assistant (matches Home) -->
    <aside class="w-full max-w-[360px] flex flex-col bg-white dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 rounded-2xl shadow-lg overflow-hidden shrink-0 h-[70vh] md:h-[78vh] max-h-[80vh]">
      <div class="bg-primary p-5 flex items-center justify-between gap-3">
        <div class="flex items-center gap-3">
          <div class="bg-white/20 p-2 rounded-lg">
            <span class="material-symbols-outlined text-white !text-2xl">smart_toy</span>
          </div>
          <div>
            <h3 class="text-white font-bold text-base leading-none">OCBC AI Assistant</h3>
            <span class="text-white/70 text-xs font-medium" id="assistantStatus">Online & Ready to Help</span>
          </div>
        </div>
        <label id="micToggleLabel" class="p-2.5 bg-white/20 rounded-full hover:bg-white/30 transition-all cursor-pointer flex items-center justify-center" title="Click to activate voice input">
          <input id="micToggle" type="checkbox" class="sr-only"/>
          <span class="material-symbols-outlined text-white !text-xl">mic</span>
        </label>
      </div>
      <div class="flex-1 overflow-y-auto p-4 flex flex-col gap-4 bg-zinc-50 dark:bg-zinc-950/20" id="chatlog"></div>
      <div class="p-4 border-t border-zinc-100 dark:border-zinc-800 bg-white dark:bg-zinc-900">
        <div class="flex items-center gap-2">
          <input id="userInput" class="flex-1 bg-zinc-100 dark:bg-zinc-800 border-2 border-zinc-200 dark:border-zinc-700 rounded-full py-3.5 px-5 text-sm focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all dark:placeholder:text-zinc-500" placeholder="Type a message..." type="text"/>
          <button id="sendBtn" class="flex-shrink-0 w-11 h-11 bg-primary text-white rounded-full hover:bg-red-700 active:scale-95 transition-all shadow-md hover:shadow-lg flex items-center justify-center group">
            <span class="material-symbols-outlined !text-xl group-hover:scale-110 transition-transform">send</span>
          </button>
        </div>
        <p class="text-[10px] text-zinc-400 text-center mt-3 flex items-center justify-center gap-1">
          <span class="material-symbols-outlined !text-[12px]">security</span>
          Private & Secure Conversation
        </p>
      </div>
    </aside>
  </main>

  <!-- Footer (matches Home) -->
  <footer class="w-full py-6 mt-auto bg-zinc-100 dark:bg-zinc-950/50 px-6">
    <div class="max-w-[1400px] mx-auto flex flex-col md:flex-row items-center justify-between gap-4 text-zinc-500 dark:text-zinc-500 text-xs font-medium">
      <div class="flex items-center gap-2">
        <span class="material-symbols-outlined !text-sm">security</span>
        <span>Your session is secure and encrypted. Please do not share your PIN.</span>
      </div>
      <div class="flex gap-6">
        <a class="hover:text-primary transition-colors" href="#">Privacy Policy</a>
        <a class="hover:text-primary transition-colors" href="#">Terms of Use</a>
        <span>© 2024 OCBC Bank</span>
      </div>
    </div>
  </footer>

  <!-- Logic: wallet transfer behaviors -->
  <script>
    // Check authentication immediately
    (function() {
      const token = localStorage.getItem('token');
      if (!token) {
        console.warn('No authentication token found. Redirecting to login...');
        window.location.href = '/login.html';
      }
    })();

    let selectedWalletType = 'alipay';
    let selectedAmount = 0;
    let currentExchangeRate = 1.0;

    // Wallet configuration with exchange rates
    const walletExchangeConfig = {
      alipay: {
        name: 'Alipay',
        targetCurrency: 'CNY',
        currencySymbol: '¥',
        currencyName: 'Chinese Yuan',
        apiCode: 'SGD_CNY',
        fallbackRate: 5.35
      },
      wechat: {
        name: 'Weixin Pay',
        targetCurrency: 'CNY',
        currencySymbol: '¥',
        currencyName: 'Chinese Yuan',
        apiCode: 'SGD_CNY',
        fallbackRate: 5.35
      },
      touchngo: {
        name: 'Touch n Go',
        targetCurrency: 'MYR',
        currencySymbol: 'RM',
        currencyName: 'Malaysian Ringgit',
        apiCode: 'SGD_MYR',
        fallbackRate: 3.45
      },
      grabpay: {
        name: 'GrabPay',
        targetCurrency: 'SGD',
        currencySymbol: 'S$',
        currencyName: 'Singapore Dollar',
        apiCode: null,
        fallbackRate: 1.0
      },
      paynow: {
        name: 'PayNow',
        targetCurrency: 'SGD',
        currencySymbol: 'S$',
        currencyName: 'Singapore Dollar',
        apiCode: null,
        fallbackRate: 1.0
      }
    };

    // Fetch live exchange rate
    async function fetchExchangeRate(walletType) {
      const config = walletExchangeConfig[walletType];
      if (!config || !config.apiCode) {
        currentExchangeRate = 1.0;
        return;
      }

      try {
        const response = await fetch(`https://open.er-api.com/v6/latest/SGD`);
        if (response.ok) {
          const data = await response.json();
          if (data.rates && data.rates[config.targetCurrency]) {
            currentExchangeRate = data.rates[config.targetCurrency];
            console.log(`Live rate: 1 SGD = ${currentExchangeRate} ${config.targetCurrency}`);
          } else {
            currentExchangeRate = config.fallbackRate;
          }
        } else {
          currentExchangeRate = config.fallbackRate;
        }
      } catch (error) {
        console.error('Exchange rate fetch error:', error);
        currentExchangeRate = config.fallbackRate;
      }

      updateExchangeInfoDisplay();
    }

    // Update the exchange info card
    function updateExchangeInfoDisplay() {
      const config = walletExchangeConfig[selectedWalletType];
      const exchangeCard = document.getElementById('exchangeInfo');
      
      // Show exchange info only for wallets that need conversion
      if (!config.apiCode) {
        exchangeCard.classList.remove('show');
        return;
      }

      exchangeCard.classList.add('show');
      
      // Update labels and currency symbols
      document.getElementById('exchangeInfoTitle').textContent = `SGD to ${config.currencyName}`;
      document.getElementById('targetCurrencyCode').textContent = config.targetCurrency;
      document.getElementById('convertedSymbol').textContent = config.currencySymbol;
      document.getElementById('rateValue').textContent = currentExchangeRate.toFixed(4);
      document.getElementById('rateUpdateTime').textContent = new Date().toLocaleTimeString();

      // Update converted amount based on current selection
      updateConvertedAmount();
    }

    // Update the converted amount when amount changes
    function updateConvertedAmount() {
      const config = walletExchangeConfig[selectedWalletType];
      const amount = selectedAmount || parseFloat(document.getElementById('transferAmount').value) || 0;
      const convertedAmount = amount * currentExchangeRate;
      
      document.getElementById('sgdAmount').textContent = amount.toFixed(2);
      document.getElementById('convertedAmount').textContent = convertedAmount.toFixed(2);
      const summary = document.getElementById('conversionSummary');
      if (summary && config) {
        summary.textContent = `S$${amount.toFixed(2)} = ${config.currencySymbol}${convertedAmount.toFixed(2)}`;
      }
    }

    // Mark Alipay as default selected visually
    document.addEventListener('DOMContentLoaded', ()=>{
      const first = document.querySelector('.wallet-type-btn[data-wallet="alipay"]');
      if(first) first.classList.add('ring-2','ring-primary/50');
    });

    // Wallet type selection
    document.querySelectorAll('.wallet-type-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        document.querySelectorAll('.wallet-type-btn').forEach(b => b.classList.remove('ring-2','ring-primary/50'));
        this.classList.add('ring-2','ring-primary/50');
        selectedWalletType = this.dataset.wallet;
        
        // Fetch exchange rate and show info card
        fetchExchangeRate(selectedWalletType);
      });
    });

    // Quick amount selection
    document.querySelectorAll('.quick-amount-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        document.querySelectorAll('.quick-amount-btn').forEach(b => b.classList.remove('bg-primary','text-white'));
        this.classList.add('bg-primary','text-white');
        selectedAmount = parseFloat(this.dataset.amount);
        const amtInput = document.getElementById('transferAmount');
        if (amtInput) amtInput.value = '';
        
        // Update converted amount
        updateConvertedAmount();
      });
    });

    // Custom amount input
    document.getElementById('transferAmount').addEventListener('input', function() {
      if (this.value) {
        document.querySelectorAll('.quick-amount-btn').forEach(b => b.classList.remove('bg-primary','text-white'));
        selectedAmount = parseFloat(this.value) || 0;
        
        // Update converted amount
        updateConvertedAmount();
      }
    });

    // Load current balance
    async function loadBalance() {
      try {
        const token = localStorage.getItem('token');
        const headers = { 'Content-Type': 'application/json' };
        if (token) {
          headers['Authorization'] = `Bearer ${token}`;
        }
        
        const response = await fetch('/account/balance', { 
          credentials: 'include',
          headers: headers
        });
        const data = await response.json();
        const el = document.getElementById('currentBalance');
        if(el) el.textContent = `S$${Number(data.balance||0).toFixed(2)}`;
      } catch (error) {
        console.error('Error loading balance:', error);
        showError('Failed to load balance');
      }
    }

    // Transfer funds
    document.getElementById('transferBtn').addEventListener('click', async function() {
      const walletId = document.getElementById('walletId').value.trim();
      const customAmount = parseFloat(document.getElementById('transferAmount').value) || 0;
      const amount = customAmount > 0 ? customAmount : selectedAmount;

      if (!walletId) { showError('Please enter a wallet ID'); return; }
      if (amount <= 0) { showError('Please select or enter an amount'); return; }

      this.disabled = true;
      this.textContent = 'Processing...';

      try {
        const token = localStorage.getItem('token');
        const headers = { 'Content-Type': 'application/json' };
        if (token) {
          headers['Authorization'] = `Bearer ${token}`;
        }
        
        const response = await fetch('/api/wallet/transfer', {
          method: 'POST',
          headers: headers,
          credentials: 'include',
          body: JSON.stringify({ amount, walletId, walletType: selectedWalletType })
        });
        const data = await response.json();

        if (response.ok) {
          showSuccess(`Successfully transferred S$${amount.toFixed(2)} to ${selectedWalletType}!`);
          const bal = document.getElementById('currentBalance');
          if (bal) bal.textContent = `S$${Number(data.accountBalance||0).toFixed(2)}`;

          // Broadcast update for mobile demo
          if (window.BroadcastChannel) {
            const channel = new BroadcastChannel('wallet-updates');
            channel.postMessage({ type: 'wallet-update', walletId, walletType: selectedWalletType, amount, newBalance: data.walletBalance });
          }

          setTimeout(() => {
            const amtInput = document.getElementById('transferAmount');
            if (amtInput) amtInput.value = '';
            selectedAmount = 0;
            document.querySelectorAll('.quick-amount-btn').forEach(b => b.classList.remove('bg-primary','text-white'));
          }, 2000);
        } else {
          showError(data.error || 'Transfer failed');
        }
      } catch (error) {
        console.error('Transfer error:', error);
        showError('Network error. Please try again.');
      } finally {
        this.disabled = false;
        this.textContent = 'Transfer Now';
      }
    });

    function showSuccess(message) {
      const el = document.getElementById('successMessage');
      if(!el) return;
      el.textContent = message;
      el.classList.remove('hidden');
      setTimeout(() => { el.classList.add('hidden'); }, 5000);
    }

    function showError(message) {
      const el = document.getElementById('errorMessage');
      if(!el) return;
      el.textContent = message;
      el.classList.remove('hidden');
      setTimeout(() => { el.classList.add('hidden'); }, 5000);
    }

    loadBalance();

    // Handle URL parameters for pre-filling from AI assistant
    const urlParams = new URLSearchParams(window.location.search);
    const presetWallet = urlParams.get('wallet');
    const presetAmount = urlParams.get('amount');

    if (presetWallet && walletExchangeConfig[presetWallet]) {
      // Select the specified wallet
      selectedWalletType = presetWallet;
      document.querySelectorAll('.wallet-type-btn').forEach(btn => {
        btn.classList.remove('ring-2', 'ring-primary/50');
        if (btn.dataset.wallet === presetWallet) {
          btn.classList.add('ring-2', 'ring-primary/50');
        }
      });
      fetchExchangeRate(selectedWalletType);
    }

    if (presetAmount) {
      const amt = parseFloat(presetAmount);
      if (amt > 0) {
        selectedAmount = amt;
        document.getElementById('transferAmount').value = amt;
        updateConvertedAmount();
      }
    }

    // Initialize exchange rate for default wallet (Alipay)
    fetchExchangeRate(selectedWalletType);
    
    // Refresh exchange rates every 5 minutes
    setInterval(() => {
      fetchExchangeRate(selectedWalletType);
    }, 300000);
  </script>

  <!-- Reuse shared behaviors (logout, assistant, etc.) -->
  <script src="scripts/home.js"></script>
</body>
</html>
