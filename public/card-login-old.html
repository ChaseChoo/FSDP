<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ATM Card Authentication - OCBCATM</title>
    <link rel="stylesheet" href="home.css">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        .topbar-fixed {
            position: sticky;
            top: 0;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            padding: 12px 24px;
            background: #ffffff;
            border-bottom: 1px solid #e5e7eb;
        }
        .topbar-brand {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 800;
            color: #ea2a33;
        }
        .topbar-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid rgba(234, 42, 51, 0.2);
            background-size: cover;
            background-position: center;
        }
        .topbar-exit {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: #ea2a33;
            color: #ffffff;
            border: none;
            border-radius: 10px;
            font-weight: 700;
            cursor: pointer;
        }
        .topbar-exit:active { transform: translateY(1px); }
        .atm-interface {
            max-width: 500px;
            margin: 0 auto;
            background: linear-gradient(135deg, #1e293b, #334155);
            border-radius: 16px;
            padding: 32px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            color: white;
        }
        
        .screen {
            background: #0f172a;
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 24px;
            border: 3px solid #475569;
            min-height: 300px;
            position: relative;
        }
        
        .screen-content {
            text-align: center;
        }
        
        .card-insertion-area {
            text-align: center;
            margin: 32px 0;
        }
        
        .card-slot {
            width: 220px;
            height: 12px;
            background: #374151;
            margin: 24px auto;
            border-radius: 6px;
            position: relative;
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.5);
        }
        
        .card-slot::before {
            content: "INSERT CARD HERE";
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 11px;
            color: #64748b;
            font-weight: 600;
            letter-spacing: 1px;
        }
        
        .card-animation {
            width: 200px;
            height: 120px;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            border-radius: 8px;
            margin: 24px auto;
            position: relative;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: none;
        }
        
        .card-animation.show {
            display: block;
            animation: cardInsert 2s ease-in-out;
        }
        
        @keyframes cardInsert {
            0% { transform: translateY(-100px) rotateY(15deg); opacity: 0; }
            50% { transform: translateY(0) rotateY(0deg); opacity: 1; }
            100% { transform: translateY(0) rotateY(0deg); opacity: 1; }
        }
        
        .chip {
            width: 24px;
            height: 18px;
            background: #fbbf24;
            border-radius: 3px;
            position: absolute;
            top: 20px;
            left: 20px;
        }
        
        .card-number {
            position: absolute;
            bottom: 30px;
            left: 20px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            color: white;
            letter-spacing: 2px;
        }
        
        .pin-entry {
            display: none;
            text-align: center;
        }
        
        .pin-entry.show {
            display: block;
        }
        
        .pin-display {
            background: #1e293b;
            border: 2px solid #475569;
            border-radius: 8px;
            padding: 16px;
            margin: 24px 0;
            font-family: 'Courier New', monospace;
            font-size: 24px;
            letter-spacing: 8px;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .keypad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            max-width: 300px;
            margin: 0 auto;
        }
        
        .keypad-btn {
            background: linear-gradient(to bottom, #e5e7eb, #d1d5db);
            border: 2px solid #9ca3af;
            border-radius: 8px;
            padding: 16px;
            font-size: 20px;
            font-weight: bold;
            color: #374151;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 60px;
        }
        
        .keypad-btn:hover {
            background: linear-gradient(to bottom, #f3f4f6, #e5e7eb);
            transform: translateY(-2px);
        }
        
        .keypad-btn:active {
            transform: translateY(0) scale(0.95);
        }
        
        .keypad-secondary {
            background: linear-gradient(to bottom, #9ca3af, #6b7280);
            color: white;
            font-size: 16px;
        }
        
        .action-buttons {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }
        
        .action-btn {
            flex: 1;
            background: linear-gradient(to bottom, #dc2626, #b91c1c);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .action-btn.confirm {
            background: linear-gradient(to bottom, #16a34a, #15803d);
        }
        
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 32px;
        }
        
        .loading.show {
            display: block;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #475569;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .status-message {
            font-size: 18px;
            margin: 16px 0;
        }
        
        .error {
            color: #ef4444;
        }
        
        .success {
            color: #10b981;
        }
        
        .back-link {
            color: #64748b;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            transition: color 0.2s;
            margin-bottom: 20px;
        }
        
        .back-link:hover {
            color: #3b82f6;
        }
    </style>
</head>
<body>
    <div class="topbar-fixed">
        <div class="topbar-brand">
            <div style="background:#ea2a33;padding:6px;border-radius:10px;display:flex;align-items:center;justify-content:center;">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" width="28" height="28" fill="#fff"><path d="M44 11.2727C44 14.0109 39.8386 16.3957 33.69 17.6364C39.8386 18.877 44 21.2618 44 24C44 26.7382 39.8386 29.123 33.69 30.3636C39.8386 31.6043 44 33.9891 44 36.7273C44 40.7439 35.0457 44 24 44C12.9543 44 4 40.7439 4 36.7273C4 33.9891 8.16144 31.6043 14.31 30.3636C8.16144 29.123 4 26.7382 4 24C4 21.2618 8.16144 18.877 14.31 17.6364C8.16144 16.3957 4 14.0109 4 11.2727C4 7.25611 12.9543 4 24 4C35.0457 4 44 7.25611 44 11.2727Z"></path></svg>
            </div>
            <span>OCBC</span>
        </div>
        <div style="display:flex;align-items:center;gap:16px;">
            <div class="topbar-avatar" style="background-image:url('https://lh3.googleusercontent.com/aida-public/AB6AXuCdXp6jm9dNfmuZgfb_wpa2l25q3fWr8-3fEVJsn7dcPLHWbHr53ylx2Hul0hw0olJfwGv6daW_MIzKFUQCcqcB-PeKhNXl_rDJ537Um-xu8XQcacQESqA1q8QqpOniullUqV1n5ZiJF3GxM89P2zHu2c4dqHTGunXCAg6YeUOoCVrCFGx3h5_m_h7ItQpaoblGp3INs2b93iWnEIkDdSouwwsOFkuujQyJnZGj2tPQUCwYS5VjnRpjCmFe8VOqvQyTqaxjEucRIqk');"></div>
            <button class="topbar-exit" onclick="window.location.href='login.html'">Back</button>
        </div>
    </div>
    <div class="container">
        <a href="login.html" class="back-link">
            <i data-lucide="arrow-left"></i>
            Back to Login Options
        </a>
        
        <header class="header">
            <div class="logo">
                <i data-lucide="landmark"></i>
                <span>OCBC ATM</span>
            </div>
        </header>

        <main class="main-content">
            <div class="atm-interface">
                <div class="screen">
                    <!-- Step 1: Card Selection -->
                    <div id="card-insertion" class="screen-content">
                        <h2>Insert Your ATM Card</h2>
                        <p>Please select which card to insert</p>
                        
                        <div class="card-insertion-area">
                            <div class="card-slot"></div>
                            
                            <div style="display: flex; gap: 16px; justify-content: center; margin-top: 24px;">
                                <button onclick="insertCard('5555444433332222')" class="keypad-btn" style="width: 180px; background: linear-gradient(135deg, #3b82f6, #1d4ed8);">
                                    <i data-lucide="credit-card"></i>
                                    Account 1<br>
                                    <span id="acct1Balance" style="font-size: 11px; opacity: 0.8;">Loading...</span>
                                </button>
                                <button onclick="insertCard('4444333322221111')" class="keypad-btn" style="width: 180px; background: linear-gradient(135deg, #10b981, #059669);">
                                    <i data-lucide="credit-card"></i>
                                    Account 2<br>
                                    <span id="acct2Balance" style="font-size: 11px; opacity: 0.8;">Loading...</span>
                                </button>
                            </div>
                        </div>
                        
                        <p style="font-size: 14px; color: #64748b; margin-top: 24px;">
                            <i data-lucide="shield-check"></i>
                            Your card information is protected with bank-level encryption
                        </p>
                    </div>
                    
                    <!-- Card Animation -->
                    <div id="card-animation" class="card-animation">
                        <div class="chip"></div>
                        <div class="card-number">•••• •••• •••• 2222</div>
                    </div>
                    
                    <!-- Step 2: PIN Entry -->
                    <div id="pin-entry" class="pin-entry">
                        <h2>Enter Your PIN</h2>
                        <p>Please enter your 4-digit PIN</p>
                        
                        <div class="pin-display" id="pin-display">
                            <span id="pin-dots"></span>
                        </div>
                        
                        <div class="keypad">
                            <button class="keypad-btn" onclick="enterDigit('1')">1</button>
                            <button class="keypad-btn" onclick="enterDigit('2')">2</button>
                            <button class="keypad-btn" onclick="enterDigit('3')">3</button>
                            <button class="keypad-btn" onclick="enterDigit('4')">4</button>
                            <button class="keypad-btn" onclick="enterDigit('5')">5</button>
                            <button class="keypad-btn" onclick="enterDigit('6')">6</button>
                            <button class="keypad-btn" onclick="enterDigit('7')">7</button>
                            <button class="keypad-btn" onclick="enterDigit('8')">8</button>
                            <button class="keypad-btn" onclick="enterDigit('9')">9</button>
                            <button class="keypad-btn keypad-secondary" onclick="clearPin()">Clear</button>
                            <button class="keypad-btn" onclick="enterDigit('0')">0</button>
                            <button class="keypad-btn keypad-secondary" onclick="deleteDigit()">Delete</button>
                        </div>
                        
                        <div class="action-buttons">
                            <button class="action-btn" onclick="cancelTransaction()">Cancel</button>
                            <button class="action-btn confirm" onclick="submitPin()" id="submit-btn" disabled>Enter</button>
                        </div>
                    </div>
                    
                    <!-- Loading State -->
                    <div id="loading" class="loading">
                        <div class="spinner"></div>
                        <div class="status-message" id="status-message">Verifying your credentials...</div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        let pin = '';
        let cardNumber = '';
        let isProcessing = false;

        // Initialize Lucide icons
        lucide.createIcons();

        // Format currency helper
        function formatCurrency(amount, currency) {
            const cur = currency || 'SGD';
            try {
                return new Intl.NumberFormat('en-SG', { 
                    style: 'currency', 
                    currency: cur,
                    minimumFractionDigits: 2
                }).format(Number(amount || 0));
            } catch {
                return `$${Number(amount || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            }
        }

        // Load live balances from database
        async function loadDemoBalances() {
            try {
                const res = await fetch('/api/card/demo-balances');
                if (!res.ok) throw new Error('Failed to load balances');
                
                const data = await res.json();
                if (data.success && data.accounts) {
                    const acct1 = data.accounts.find(a => a.cardNumber === '5555444433332222');
                    const acct2 = data.accounts.find(a => a.cardNumber === '4444333322221111');
                    
                    if (acct1) {
                        document.getElementById('acct1Balance').textContent = formatCurrency(acct1.balance, acct1.currency);
                    }
                    if (acct2) {
                        document.getElementById('acct2Balance').textContent = formatCurrency(acct2.balance, acct2.currency);
                    }
                    lucide.createIcons();
                } else {
                    throw new Error('Invalid response format');
                }
            } catch (error) {
                console.warn('Could not load live balances, using fallback:', error);
                document.getElementById('acct1Balance').textContent = '$5,000.00';
                document.getElementById('acct2Balance').textContent = '$7,500.00';
            }
        }

        // Load balances on page load
        loadDemoBalances();

        function insertCard(selectedCardNumber) {
            if (isProcessing) return;
            
            cardNumber = selectedCardNumber;
            
            // Hide insertion screen
            document.getElementById('card-insertion').style.display = 'none';
            
            // Show card animation
            const cardAnimation = document.getElementById('card-animation');
            cardAnimation.classList.add('show');
            
            // After animation, show PIN entry
            setTimeout(() => {
                cardAnimation.style.display = 'none';
                document.getElementById('pin-entry').classList.add('show');
            }, 2500);
        }

        function enterDigit(digit) {
            if (pin.length < 4 && !isProcessing) {
                pin += digit;
                updatePinDisplay();
                
                if (pin.length === 4) {
                    document.getElementById('submit-btn').disabled = false;
                }
            }
        }

        function deleteDigit() {
            if (pin.length > 0 && !isProcessing) {
                pin = pin.slice(0, -1);
                updatePinDisplay();
                
                if (pin.length < 4) {
                    document.getElementById('submit-btn').disabled = true;
                }
            }
        }

        function clearPin() {
            if (!isProcessing) {
                pin = '';
                updatePinDisplay();
                document.getElementById('submit-btn').disabled = true;
            }
        }

        function updatePinDisplay() {
            const dots = '•'.repeat(pin.length);
            document.getElementById('pin-dots').textContent = dots;
        }

        async function submitPin() {
            if (pin.length !== 4 || isProcessing) return;
            
            isProcessing = true;
            
            // Hide PIN entry and show loading
            document.getElementById('pin-entry').style.display = 'none';
            document.getElementById('loading').classList.add('show');
            
            try {
                const response = await fetch('/api/card/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        cardNumber: cardNumber,
                        pin: pin
                    }),
                });

                const data = await response.json();
                
                if (response.ok) {
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('user', JSON.stringify(data.user));
                    
                    document.getElementById('status-message').innerHTML = 
                        '<span class="success">✓ Authentication successful!</span>';
                    
                    setTimeout(() => {
                        window.location.href = '/home.html';
                    }, 2000);
                } else {
                    throw new Error(data.message || 'Authentication failed');
                }
            } catch (error) {
                document.getElementById('status-message').innerHTML = 
                    '<span class="error">✗ ' + error.message + '</span>';
                
                setTimeout(() => {
                    pin = '';
                    updatePinDisplay();
                    isProcessing = false;
                    
                    document.getElementById('loading').classList.remove('show');
                    document.getElementById('pin-entry').style.display = 'block';
                }, 3000);
            }
        }

        function cancelTransaction() {
            if (confirm('Are you sure you want to cancel this transaction?')) {
                window.location.href = '/login';
            }
        }

        document.addEventListener('keydown', function(event) {
            if (document.getElementById('pin-entry').classList.contains('show') && !isProcessing) {
                if (event.key >= '0' && event.key <= '9') {
                    enterDigit(event.key);
                } else if (event.key === 'Backspace') {
                    deleteDigit();
                } else if (event.key === 'Enter' && pin.length === 4) {
                    submitPin();
                } else if (event.key === 'Escape') {
                    clearPin();
                }
            }
        });
    </script>
</body>
</html>