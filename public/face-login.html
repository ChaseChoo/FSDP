<!DOCTYPE html>
<html class="light" lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OCBC ATM - Face Recognition</title>
    <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <link rel="stylesheet" href="styles/home.css">
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#ea2a33",
                        "background-light": "#f8f6f6",
                        "background-dark": "#211111",
                    },
                    fontFamily: {
                        "display": ["Public Sans", "sans-serif"]
                    },
                },
            },
        }
    </script>
    <style>
        body {
            font-family: "Public Sans", sans-serif;
        }
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
        
        .video-container {
            position: relative;
            width: 100%;
            background: #000;
            border-radius: 16px;
            overflow: hidden;
        }
        
        video {
            width: 100%;
            display: block;
        }
        
        canvas {
            position: absolute;
            top: 0;
            left: 0;
        }
        
        .detection-info {
            position: absolute;
            bottom: 12px;
            left: 12px;
            right: 12px;
            padding: 8px 12px;
            background: rgba(59, 130, 246, 0.9);
            color: white;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            text-align: center;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #e5e7eb;
            border-top-color: #ea2a33;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark text-slate-900 dark:text-slate-100 min-h-screen flex flex-col">
<div class="relative flex h-full min-h-screen w-full flex-col group/design-root overflow-x-hidden">
<div class="layout-container flex h-full grow flex-col">

<!-- HEADER -->
<header class="w-full bg-white dark:bg-zinc-900 border-b border-[#f3e7e8] dark:border-zinc-800 px-6 lg:px-12 py-4 sticky top-0 z-50">
<div class="max-w-[1400px] mx-auto flex items-center justify-between">
<div class="flex items-center gap-3">
<a href="login.html" class="cursor-pointer">
<img src="sources/logo_ocbc.png" alt="OCBC Logo" class="h-8 hover:opacity-80 transition-opacity">
</a>
</div>
<div class="flex items-center gap-3">
<button id="backBtn" onclick="window.location.href='login.html'" class="bg-primary text-white px-6 py-2 rounded-lg font-bold text-sm flex items-center gap-2 hover:bg-red-700 transition-colors">
<span class="material-symbols-outlined !text-lg">arrow_back</span>
                    Back
                </button>
</div>
</div>
</header>

<!-- MAIN CONTENT -->
<main class="flex-1 flex flex-col items-center justify-center px-4 py-12 relative">
<div class="max-w-[800px] w-full flex flex-col items-center">
<div class="text-center mb-12">
<h1 class="text-slate-900 dark:text-white tracking-tight text-[44px] font-bold leading-tight pb-2 font-display">
Face Recognition Login
</h1>
<h2 class="text-slate-500 dark:text-slate-400 text-lg font-medium leading-tight tracking-tight">
Look at the camera to authenticate
</h2>
</div>

<div class="w-full max-w-[700px] bg-white dark:bg-slate-900 rounded-3xl p-8 shadow-2xl shadow-slate-200 dark:shadow-none border border-slate-100 dark:border-slate-800 relative overflow-hidden">
<div class="absolute -top-24 -right-24 w-64 h-64 bg-primary/5 rounded-full"></div>

<div class="relative z-10">
<!-- VIDEO SECTION -->
<div class="video-container mb-6" style="min-height: 400px;">
<video id="video" playsinline muted></video>
<canvas id="canvas"></canvas>
<div id="detectionInfo" class="detection-info">
Position your face in the center
</div>
</div>

<!-- STATUS -->
<div id="status" class="w-full px-4 py-3 rounded-lg border flex items-center gap-3 bg-blue-50 dark:bg-blue-900/20 border-blue-200 dark:border-blue-800 mb-6">
<div class="loading-spinner"></div>
<span class="text-blue-900 dark:text-blue-200 text-sm font-medium">Loading face detection...</span>
</div>

<!-- OVERLAY MESSAGE (for enrollment prompt) -->
<div id="overlay" style="display:none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); border-radius: 16px; display: flex; align-items: center; justify-content: center; z-index: 50;">
<div class="text-center text-white px-6">
<p class="text-lg font-semibold mb-4">No enrolled faces found</p>
<p class="text-sm mb-6">Please enroll your face first in the Face Enrollment page</p>
<button onclick="window.location.href='face-enrollment.html'" class="px-6 py-2 bg-primary rounded-lg font-bold hover:bg-primary/90 transition-colors">Enroll Face</button>
</div>
</div>

<!-- TIPS -->
<div class="mt-6 p-4 bg-slate-50 dark:bg-slate-800 rounded-lg border border-slate-200 dark:border-slate-700">
<div class="flex items-center gap-2 mb-3">
<span class="material-symbols-outlined text-primary">info</span>
<h3 class="font-bold text-slate-900 dark:text-white">Tips:</h3>
</div>
<ul class="text-sm text-slate-600 dark:text-slate-400 space-y-1">
<li>‚Ä¢ Ensure good lighting on your face</li>
<li>‚Ä¢ Look directly at the camera</li>
<li>‚Ä¢ Keep your face clear and centered</li>
</ul>
</div>
</div>
</div>
</div>
</main>

<!-- FOOTER -->
<footer class="p-8 flex flex-col items-center gap-6 border-t border-slate-200 dark:border-slate-800">
<div class="text-slate-400 text-xs text-center">
¬© 2024 OCBC Bank. All rights reserved.
</div>
</footer>

</div>
</div>

<script>
class FaceLogin {
    constructor() {
        this.video = document.getElementById('video');
        this.canvas = document.getElementById('canvas');
        this.statusDiv = document.getElementById('status');
        this.overlay = document.getElementById('overlay');
        this.detectionInfo = document.getElementById('detectionInfo');
        this.labeledDescriptors = [];
        this.isAuthenticating = false;
        
        this.init();
    }
    
    async init() {
        this.updateStatus('loading', '‚è≥ Loading face detection models...');
        
        try {
            // Load face-api models from jsdelivr GitHub CDN
            const MODEL_URL = 'https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@master/weights/';
            console.log('Loading models from:', MODEL_URL);
            
            await Promise.all([
                faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                faceapi.nets.faceExpressionNet.loadFromUri(MODEL_URL),
                faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
            ]);
            
            console.log('‚úÖ Models loaded');
            
            // Load enrolled faces
            this.loadEnrolledFaces();
            
            // Start video stream
            await this.startVideo();
            
            // Start detection
            this.startDetection();
            
        } catch (error) {
            console.error('Init error:', error);
            this.updateStatus('error', '‚ùå ' + error.message);
        }
    }
    
    async startVideo() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: 'user', width: 640, height: 480 }
            });
            
            this.video.srcObject = stream;
            
            return new Promise(resolve => {
                this.video.onloadedmetadata = () => {
                    this.video.play();
                    // Wait a bit more for video to be fully ready
                    setTimeout(() => {
                        console.log('Video dimensions:', this.video.videoWidth, 'x', this.video.videoHeight);
                        resolve();
                    }, 500);
                };
            });
        } catch (error) {
            throw new Error('Camera access denied. Please enable camera access.');
        }
    }
    
    loadEnrolledFaces() {
        try {
            console.log('Checking localStorage for enrolledFaces...');
            const stored = localStorage.getItem('enrolledFaces');
            console.log('Raw localStorage data:', stored);
            
            if (!stored) {
                throw new Error('No enrolled faces found. Please enroll your face first.');
            }
            
            const enrolledFaces = JSON.parse(stored);
            console.log('Parsed enrolled faces:', enrolledFaces);
            
            if (!Array.isArray(enrolledFaces) || enrolledFaces.length === 0) {
                throw new Error('No enrolled faces found. Please enroll your face first.');
            }
            
            // Convert stored descriptors back to Float32Array for face-api.js
            this.labeledDescriptors = enrolledFaces.map(face => ({
                label: face.name,
                cardNumber: face.cardNumber,
                descriptors: face.descriptors.map(desc => new Float32Array(desc))
            }));
            
            console.log(`‚úÖ Loaded ${this.labeledDescriptors.length} enrolled face(s):`, 
                this.labeledDescriptors.map(f => f.label));
            
            // Hide the overlay since faces were loaded successfully
            this.overlay.style.display = 'none';
            
        } catch (error) {
            console.error('Error loading enrolled faces:', error);
            this.updateStatus('error', '‚ùå ' + error.message);
            this.overlay.style.display = 'flex';
        }
    }
    
    async startDetection() {
        this.updateStatus('scanning', 'üë§ Looking for your face...');
        
        // Make sure video has dimensions
        if (!this.video.videoWidth || !this.video.videoHeight) {
            console.error('Video not ready, dimensions:', this.video.videoWidth, this.video.videoHeight);
            this.updateStatus('error', '‚ùå Camera not ready. Please refresh the page.');
            return;
        }
        
        const canvas = faceapi.createCanvasFromMedia(this.video);
        this.canvas.parentElement.append(canvas);
        
        const displaySize = { width: this.video.videoWidth, height: this.video.videoHeight };
        console.log('Display size:', displaySize);
        faceapi.matchDimensions(canvas, displaySize);
        
        setInterval(async () => {
            if (this.isAuthenticating) return;
            
            const detections = await faceapi
                .detectAllFaces(this.video, new faceapi.TinyFaceDetectorOptions())
                .withFaceLandmarks()
                .withFaceExpressions()
                .withFaceDescriptors();
            
            const resizedDetections = faceapi.resizeResults(detections, displaySize);
            
            canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
            
            if (detections.length > 0) {
                // Draw detection boxes
                faceapi.draw.drawDetections(canvas, resizedDetections);
                faceapi.draw.drawFaceLandmarks(canvas, resizedDetections);
                
                const detection = detections[0];
                const confidence = detection.detection.score;
                
                this.detectionInfo.textContent = `Face detected (${(confidence * 100).toFixed(1)}% confidence)`;
                this.detectionInfo.style.background = 'rgba(34, 197, 94, 0.9)';
                
                // High confidence detection - authenticate
                if (confidence > 0.6 && !this.isAuthenticating) {
                    await this.authenticate(detection);
                }
            } else {
                this.detectionInfo.textContent = 'No face detected - please position your face';
                this.detectionInfo.style.background = 'rgba(239, 68, 68, 0.9)';
            }
        }, 100);
    }
    
    async authenticate(detection) {
        this.isAuthenticating = true;
        this.updateStatus('success', 'üîç Matching face...');
        
        try {
            // Get the detected face descriptor
            const detectedDescriptor = detection.descriptor;
            
            // Find best match from enrolled faces
            let bestMatch = null;
            let bestDistance = 1.0; // Lower is better, max distance for match
            
            for (const enrolled of this.labeledDescriptors) {
                for (const knownDescriptor of enrolled.descriptors) {
                    const distance = faceapi.euclideanDistance(detectedDescriptor, knownDescriptor);
                    
                    console.log(`Distance to ${enrolled.label}: ${distance.toFixed(3)}`);
                    
                    // Face match threshold: 0.6 (adjust for sensitivity)
                    if (distance < 0.6 && distance < bestDistance) {
                        bestDistance = distance;
                        bestMatch = enrolled;
                    }
                }
            }
            
            if (!bestMatch) {
                throw new Error('Face not recognized. Please enroll first or try again.');
            }
            
            const confidence = ((1 - bestDistance) * 100).toFixed(1);
            this.updateStatus('success', `‚úÖ Face recognized as ${bestMatch.label} (${confidence}% match)! Logging in...`);
            
            // Call backend to get token
            const response = await fetch('api/card/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    cardNumber: bestMatch.cardNumber,
                    pin: '1234' // Demo PIN
                })
            });
            
            if (response.ok) {
                const data = await response.json();
                
                // Store token
                localStorage.setItem('token', data.token);
                localStorage.setItem('user', JSON.stringify(data.user));
                localStorage.setItem('account', JSON.stringify(data.account));
                
                // Add speech feedback
                this.speak(`Welcome back, ${data.user.firstName}`);
                
                // Redirect
                setTimeout(() => {
                    window.location.href = 'home.html';
                }, 2000);
            } else {
                throw new Error('Authentication failed');
            }
        } catch (error) {
            console.error('Auth error:', error);
            this.updateStatus('error', '‚ùå ' + error.message);
            this.isAuthenticating = false;
        }
    }
    
    updateStatus(type, message) {
        const statusClass = {
            'loading': 'bg-blue-50 dark:bg-blue-900/20 border-blue-200 dark:border-blue-800',
            'scanning': 'bg-blue-50 dark:bg-blue-900/20 border-blue-200 dark:border-blue-800',
            'success': 'bg-green-50 dark:bg-green-900/20 border-green-200 dark:border-green-800',
            'error': 'bg-red-50 dark:bg-red-900/20 border-red-200 dark:border-red-800'
        }[type] || 'bg-blue-50 dark:bg-blue-900/20 border-blue-200 dark:border-blue-800';
        
        const textClass = {
            'loading': 'text-blue-900 dark:text-blue-200',
            'scanning': 'text-blue-900 dark:text-blue-200',
            'success': 'text-green-900 dark:text-green-200',
            'error': 'text-red-900 dark:text-red-200'
        }[type] || 'text-blue-900 dark:text-blue-200';
        
        this.statusDiv.className = `w-full px-4 py-3 rounded-lg border flex items-center gap-3 ${statusClass}`;
        this.statusDiv.innerHTML = `<span class="${textClass} text-sm font-medium">${message}</span>`;
    }
    
    speak(text) {
        if ('speechSynthesis' in window) {
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = 0.9;
            utterance.pitch = 1;
            window.speechSynthesis.speak(utterance);
        }
    }
}

// Wait for face-api library to load
function waitForFaceApi() {
    return new Promise((resolve) => {
        if (typeof faceapi !== 'undefined') {
            resolve();
        } else {
            const checkInterval = setInterval(() => {
                if (typeof faceapi !== 'undefined') {
                    clearInterval(checkInterval);
                    resolve();
                }
            }, 100);
        }
    });
}

// Initialize when page loads and library is ready
document.addEventListener('DOMContentLoaded', async () => {
    await waitForFaceApi();
    new FaceLogin();
});
</script>
</body>
</html>
