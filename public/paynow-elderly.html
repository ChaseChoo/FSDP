<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EasyATM â€” Send Money Safely</title>
  <link rel="stylesheet" href="styles-elderly.css" />
</head>
<body>
<div class="container">
  <header class="header">
    <div class="brand">
      <div class="logo" aria-hidden="true"><span>EA</span></div>
      <div class="title">
        <h1>ğŸ’¸ Send Money (PayNow)</h1>
        <div class="subtitle">Safe â€¢ Simple â€¢ Secure</div>
      </div>
    </div>
    <div class="safe" role="group" aria-label="Safe Mode">
      <input id="safemode" type="checkbox" checked aria-describedby="safe-description" />
      <label for="safemode">ğŸ›¡ï¸ Safe Mode</label>
    </div>
  </header>

  <!-- Enhanced Safety Banner -->
  <div class="banner card" role="alert" aria-live="assertive">
    <div>ğŸš¨</div>
    <div>
      <strong>STOP! Before You Send Money:</strong>
      <div style="margin-top: 8px;">
        âœ… Do you know this person personally?<br>
        âœ… Did YOU decide to send this money?<br>
        âŒ Did someone call or text asking you to send money? <strong style="color: #dc3545;">IT'S A SCAM!</strong>
      </div>
      <div class="tip">
        <strong>When in doubt, DON'T send.</strong> Call a family member or our support line first.
      </div>
    </div>
  </div>

  <main class="card">
    <!-- Step Progress Indicator -->
    <div style="background: #f0f9ff; padding: 16px; border-radius: 12px; margin-bottom: 24px; border: 2px solid #0ea5e9;">
      <h3 style="margin: 0; color: #0ea5e9;">ğŸ“‹ Step 1 of 3: Choose Who to Send Money To</h3>
      <div style="margin-top: 8px; font-size: 16px;">
        Step 1: Choose recipient â†’ Step 2: Enter amount â†’ Step 3: Confirm
      </div>
    </div>

    <form id="paynow-form" aria-describedby="form-instructions">
      <div id="form-instructions" class="sr-only">
        Fill out this form to send money. All fields marked with an asterisk are required.
      </div>

      <!-- Recipient Selection -->
      <div class="row">
        <label for="method" style="font-size: 20px;">
          <span>ğŸ“‹ How do you want to identify the person?</span>
          <span style="color: #dc3545;">*</span>
        </label>
        <select id="method" name="method" required aria-describedby="method-help" style="font-size: 18px;">
          <option value="">ğŸ‘¥ Choose identification method...</option>
          <option value="Mobile Number">ğŸ“± Mobile Phone Number (8 digits)</option>
          <option value="NRIC/FIN">ğŸ†” NRIC or FIN Number</option>
          <option value="UEN">ğŸ¢ Company UEN Number</option>
        </select>
        <div id="method-help" class="hint">
          ğŸ’¡ Most people use mobile phone numbers. Choose NRIC for government payments.
        </div>
      </div>

      <!-- Safe Mode Recipient Selection -->
      <div class="row" id="safe-recipient-section" style="display: none;">
        <label for="recipient-select" style="font-size: 20px;">
          <span>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ Choose from your trusted contacts</span>
          <span style="color: #dc3545;">*</span>
        </label>
        <select id="recipient-select" name="recipient-select" style="font-size: 18px;">
          <option value="">ğŸ‘¥ Select a trusted person...</option>
        </select>
        <div class="hint">
          âœ… These are people you've marked as safe to send money to.
        </div>
      </div>

      <!-- Manual Recipient Entry -->
      <div class="row" id="manual-recipient-section">
        <label for="recipient" style="font-size: 20px;">
          <span>ğŸ‘¤ Enter their phone number or NRIC</span>
          <span style="color: #dc3545;">*</span>
        </label>
        <input 
          id="recipient" 
          name="recipient" 
          type="text" 
          placeholder="e.g., 91234567 or S1234567A" 
          required 
          aria-describedby="recipient-help"
          style="font-size: 18px;"
        />
        <div id="recipient-help" class="hint">
          âš ï¸ <strong>WARNING:</strong> Only send money to people you know personally. 
          If someone told you to send money here, it could be a SCAM.
        </div>
      </div>

      <!-- Amount Section -->
      <div class="row">
        <label for="amount" style="font-size: 20px;">
          <span>ğŸ’° How much do you want to send? (SGD)</span>
          <span style="color: #dc3545;">*</span>
        </label>
        <input 
          id="amount" 
          name="amount" 
          type="number" 
          min="1" 
          max="5000" 
          step="1" 
          placeholder="Enter amount in dollars" 
          required
          aria-describedby="amount-help"
          style="font-size: 18px;"
        />
        
        <!-- Quick Amount Buttons -->
        <div class="chips" aria-label="Quick amount selection">
          <button type="button" class="chip" onclick="setAmount(10)">$10</button>
          <button type="button" class="chip" onclick="setAmount(20)">$20</button>
          <button type="button" class="chip" onclick="setAmount(50)">$50</button>
          <button type="button" class="chip" onclick="setAmount(100)">$100</button>
          <button type="button" class="chip" onclick="setAmount(200)">$200</button>
          <button type="button" class="chip" onclick="setAmount(500)">$500</button>
        </div>
        
        <div id="amount-help" class="hint">
          ğŸ’¡ Click the buttons above for common amounts. Maximum $5,000 per transaction.
        </div>
      </div>

      <!-- Purpose Section -->
      <div class="row">
        <label for="purpose" style="font-size: 20px;">
          ğŸ“ What is this payment for? (Optional)
        </label>
        <input 
          id="purpose" 
          name="purpose" 
          type="text" 
          placeholder="e.g., Allowance, Groceries, Birthday gift" 
          aria-describedby="purpose-help"
          style="font-size: 18px;"
        />
        <div id="purpose-help" class="hint">
          ğŸ’¡ This helps you remember what the payment was for.
          âš ï¸ AVOID words like "secure", "urgent", "refund" - these are scam warning signs.
        </div>
      </div>

      <!-- Summary Before Submission -->
      <div id="transaction-summary" class="summary" style="display: none;">
        <h4 style="color: #c41230; margin-bottom: 12px;">ğŸ“‹ Please Review:</h4>
        <div id="summary-content" style="font-size: 18px; line-height: 1.6;"></div>
      </div>

      <!-- Action Buttons -->
      <div class="actions">
        <a href="index-elderly.html" class="btn btn-ghost btn-lg">
          â† Back to Main Menu
        </a>
        <button type="button" class="btn btn-secondary btn-lg" onclick="clearForm()" id="clear-btn">
          ğŸ—‘ï¸ Clear Form
        </button>
        <button type="button" class="btn btn-primary btn-lg" onclick="reviewTransaction()" id="review-btn" disabled>
          ğŸ‘€ Review Transaction
        </button>
      </div>
    </form>
  </main>

  <!-- Help Section -->
  <div class="card" style="background: #fff9c4; border-color: #f59e0b;">
    <h3>ğŸ†˜ Need Help?</h3>
    <div class="actions">
      <button class="btn btn-secondary" onclick="explainPayNow()">
        ğŸ”Š Explain PayNow
      </button>
      <button class="btn btn-secondary" onclick="showCommonScams()">
        ğŸš¨ Common Scams to Avoid
      </button>
      <button class="btn btn-secondary" onclick="callSupport()">
        ğŸ“ Call Support (1800-EASYATM)
      </button>
    </div>
  </div>

  <footer class="footnotes">
    <p><strong>ğŸ›¡ï¸ Your Safety is Our Priority</strong></p>
    <p>âœ… We never ask you to send money to "secure" your account</p>
    <p>âœ… Take time to think - real emergencies don't require instant money transfers</p>
    <p>âœ… When in doubt, call us at 1800-EASYATM (1800-327-9286)</p>
  </footer>
</div>

<!-- Common Scams Information Modal -->
<div id="scams-modal" class="dialog" role="dialog" aria-hidden="true">
  <div class="modal" style="max-width: 600px;">
    <h3>ğŸš¨ Common Scams Targeting Seniors</h3>
    <div style="text-align: left; font-size: 18px; line-height: 1.6;">
      <h4 style="color: #dc3545;">âŒ NEVER Send Money For:</h4>
      <ul>
        <li><strong>"Account Security":</strong> "Your account is compromised, transfer money to this safe account"</li>
        <li><strong>"Police/Court Fines":</strong> "You have unpaid fines, pay now or be arrested"</li>
        <li><strong>"Family Emergency":</strong> "Your grandchild is in trouble, send money immediately"</li>
        <li><strong>"Investment/Loan":</strong> "Guaranteed returns, just pay processing fee first"</li>
        <li><strong>"Prize/Refund":</strong> "You won money, pay tax/fee to claim"</li>
        <li><strong>"Romance Scam":</strong> Online friend needs money for emergency</li>
      </ul>
      
      <h4 style="color: #28a745;">âœ… Remember:</h4>
      <ul>
        <li>Banks NEVER ask you to transfer money for security</li>
        <li>Police and courts don't collect fines via PayNow</li>
        <li>Real emergencies don't require instant money transfers</li>
        <li>Legitimate companies don't ask for upfront fees</li>
        <li>When someone pressures you to "act fast" - it's usually a scam</li>
      </ul>
      
      <div style="background: #fef2f2; border: 2px solid #dc3545; padding: 16px; border-radius: 8px; margin: 16px 0;">
        <h4 style="color: #dc3545; margin-top: 0;">ğŸ†˜ If You Think You're Being Scammed:</h4>
        <ol>
          <li><strong>STOP</strong> - Don't send any money</li>
          <li><strong>HANG UP</strong> - End the call immediately</li>
          <li><strong>VERIFY</strong> - Call the official number yourself</li>
          <li><strong>REPORT</strong> - Call Anti-Scam Hotline: 1800-722-6688</li>
          <li><strong>GET HELP</strong> - Ask family member or call us: 1800-EASYATM</li>
        </ol>
      </div>
    </div>
    <div class="actions">
      <button class="btn btn-primary btn-lg" onclick="closeModal('scams-modal')">
        I Understand - Keep Me Safe
      </button>
    </div>
  </div>
</div>

<script src="app-elderly.js"></script>
<script>
// Enhanced PayNow functionality for elderly users
let currentTransaction = {};

// Form validation and enhancement
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('paynow-form');
  const safeToggle = document.getElementById('safemode');
  const methodSelect = document.getElementById('method');
  const recipientInput = document.getElementById('recipient');
  const amountInput = document.getElementById('amount');
  const purposeInput = document.getElementById('purpose');
  
  // Enhanced form monitoring
  [methodSelect, recipientInput, amountInput, purposeInput].forEach(field => {
    if (field) {
      field.addEventListener('input', updateFormState);
      field.addEventListener('change', updateFormState);
    }
  });
  
  // Safe mode toggle handling
  if (safeToggle) {
    safeToggle.addEventListener('change', function() {
      updateSafeModeDisplay();
      updateFormState();
    });
    updateSafeModeDisplay(); // Initial setup
  }
  
  // Initial state
  updateFormState();
  
  // Welcome message
  setTimeout(() => {
    ttsSpeak("PayNow page loaded. Please choose how to identify the person you want to send money to. Remember: only send money to people you know personally.", 'normal');
  }, 1500);
});

function updateSafeModeDisplay() {
  const safeToggle = document.getElementById('safemode');
  const safeSection = document.getElementById('safe-recipient-section');
  const manualSection = document.getElementById('manual-recipient-section');
  const recipientSelect = document.getElementById('recipient-select');
  
  if (safeToggle && safeToggle.checked) {
    // Show safe mode recipient selection
    if (safeSection) safeSection.style.display = 'block';
    if (manualSection) manualSection.style.display = 'none';
    
    // Populate trusted contacts
    if (recipientSelect) {
      recipientSelect.innerHTML = '<option value="">ğŸ‘¥ Select a trusted person...</option>';
      approvedRecipients.forEach(contact => {
        const option = document.createElement('option');
        option.value = contact.value;
        option.textContent = contact.label;
        recipientSelect.appendChild(option);
      });
    }
    
    ttsSpeak("Safe mode enabled. You can only send money to your trusted contacts.", 'normal');
  } else {
    // Show manual entry
    if (safeSection) safeSection.style.display = 'none';
    if (manualSection) manualSection.style.display = 'block';
    
    ttsSpeak("Safe mode disabled. Please be extra careful about who you send money to. Only send to people you know personally.", 'urgent');
  }
}

function updateFormState() {
  const method = document.getElementById('method')?.value || '';
  const safeToggle = document.getElementById('safemode');
  const recipient = safeToggle?.checked ? 
    document.getElementById('recipient-select')?.value || '' :
    document.getElementById('recipient')?.value || '';
  const amount = document.getElementById('amount')?.value || '';
  const purpose = document.getElementById('purpose')?.value || '';
  
  // Update current transaction object
  currentTransaction = { method, recipient, amount, purpose };
  
  // Enable/disable review button
  const reviewBtn = document.getElementById('review-btn');
  const canReview = method && recipient && amount && parseFloat(amount) > 0;
  
  if (reviewBtn) {
    reviewBtn.disabled = !canReview;
    if (canReview) {
      reviewBtn.style.opacity = '1';
      reviewBtn.style.cursor = 'pointer';
    } else {
      reviewBtn.style.opacity = '0.6';
      reviewBtn.style.cursor = 'not-allowed';
    }
  }
  
  // Update summary if all fields filled
  if (canReview) {
    updateTransactionSummary();
  } else {
    const summary = document.getElementById('transaction-summary');
    if (summary) summary.style.display = 'none';
  }
}

function updateTransactionSummary() {
  const summary = document.getElementById('transaction-summary');
  const content = document.getElementById('summary-content');
  
  if (summary && content) {
    const { method, recipient, amount, purpose } = currentTransaction;
    
    // Get recipient display name
    let recipientDisplay = recipient;
    const safeToggle = document.getElementById('safemode');
    if (safeToggle?.checked) {
      const selectedContact = approvedRecipients.find(c => c.value === recipient);
      recipientDisplay = selectedContact ? selectedContact.label : recipient;
    }
    
    content.innerHTML = `
      <div><strong>Method:</strong> ${method}</div>
      <div><strong>Send to:</strong> ${recipientDisplay}</div>
      <div><strong>Amount:</strong> ${formatCurrency(amount)}</div>
      ${purpose ? `<div><strong>Purpose:</strong> ${purpose}</div>` : ''}
    `;
    
    summary.style.display = 'block';
  }
}

function setAmount(value) {
  const amountInput = document.getElementById('amount');
  if (amountInput) {
    amountInput.value = value;
    amountInput.focus();
    ttsSpeak(`Amount set to ${value} dollars`, 'normal');
    updateFormState();
    
    // Visual feedback
    event.target.style.transform = 'scale(1.1)';
    setTimeout(() => {
      event.target.style.transform = 'scale(1)';
    }, 200);
  }
}

function clearForm() {
  const form = document.getElementById('paynow-form');
  if (form) {
    form.reset();
    currentTransaction = {};
    updateFormState();
    ttsSpeak("Form cleared. You can start over.", 'normal');
    
    // Focus first field
    const methodSelect = document.getElementById('method');
    if (methodSelect) methodSelect.focus();
  }
}

async function reviewTransaction() {
  const { method, recipient, amount, purpose } = currentTransaction;
  
  // Validation
  if (!method || !recipient || !amount) {
    showElderlyError("Please fill in all required fields before reviewing.", "Check that you've selected a method, recipient, and amount.");
    return;
  }
  
  const amountNum = parseFloat(amount);
  if (amountNum <= 0 || amountNum > 5000) {
    showElderlyError("Please enter an amount between $1 and $5,000.", "Check the amount you entered.");
    return;
  }
  
  // Scam detection
  const scamRisk = detectElderlyScamRisk(recipient, amount, purpose);
  
  if (scamRisk.high) {
    const continueAnyway = await elderlyConfirm(
      `ğŸš¨ HIGH SCAM RISK DETECTED!\n\n${scamRisk.reason}\n\nThis transaction looks very suspicious. We strongly recommend you DO NOT send this money.\n\nOnly continue if you are 100% certain this is safe.`,
      'payment'
    );
    
    if (!continueAnyway) {
      ttsSpeak("Transaction cancelled for your safety. Thank you for being careful.", 'normal');
      return;
    }
  } else if (scamRisk.medium) {
    const continueAnyway = await elderlyConfirm(
      `âš ï¸ POTENTIAL SCAM WARNING\n\n${scamRisk.reason}\n\nPlease double-check this is someone you know personally.\n\nAre you sure you want to continue?`,
      'payment'
    );
    
    if (!continueAnyway) {
      ttsSpeak("Transaction cancelled. Better safe than sorry!", 'normal');
      return;
    }
  }
  
  // Final confirmation
  let recipientDisplay = recipient;
  const safeToggle = document.getElementById('safemode');
  if (safeToggle?.checked) {
    const selectedContact = approvedRecipients.find(c => c.value === recipient);
    recipientDisplay = selectedContact ? selectedContact.label : recipient;
  }
  
  const confirmMessage = `
    Please confirm you want to send ${formatCurrency(amount)} to:
    ${recipientDisplay}
    
    ${purpose ? `For: ${purpose}` : ''}
    
    Once you confirm, the money will be sent immediately and cannot be cancelled.
    
    Are you absolutely sure this is correct?
  `;
  
  const finalConfirmed = await elderlyConfirm(confirmMessage, 'payment');
  
  if (finalConfirmed) {
    // Store transaction data
    localStorage.setItem("paynow_method", method);
    localStorage.setItem("paynow_recipient", recipient);
    localStorage.setItem("paynow_amount", amount);
    localStorage.setItem("paynow_purpose", purpose);
    localStorage.setItem("paynow_timestamp", new Date().toISOString());
    
    ttsSpeak("Proceeding to final confirmation page", 'normal');
    
    // Navigate to confirmation
    window.location.href = "confirm-paynow-elderly.html";
  } else {
    ttsSpeak("Transaction not sent. You can modify the details or start over.", 'normal');
  }
}

// Help functions
function explainPayNow() {
  const explanation = `
    PayNow is Singapore's instant payment system. Here's how it works:
    
    Step 1: Choose how to identify the person - usually their mobile phone number.
    Step 2: Enter their 8-digit mobile number, like 91234567.
    Step 3: Enter how much money to send, from 1 dollar up to 5000 dollars.
    Step 4: Optionally write what the payment is for.
    Step 5: Review everything carefully before confirming.
    
    The money is sent instantly and cannot be cancelled once confirmed.
    
    Only send money to people you know personally. Never send money because someone called or texted asking you to.
    
    If you're not sure about something, call us at 1800 EASYATM for help.
  `;
  
  ttsSpeak(explanation, 'normal');
}

function showCommonScams() {
  const modal = document.getElementById('scams-modal');
  if (modal) {
    modal.classList.add('show');
    modal.setAttribute('aria-hidden', 'false');
    
    // Focus first button
    const button = modal.querySelector('button');
    if (button) button.focus();
    
    ttsSpeak("Showing information about common scams. Please read this carefully to protect yourself.", 'urgent');
  }
}

function callSupport() {
  const supportMsg = "You can call our support team at 1800 EASYATM. That's 1-8-0-0-3-2-7-9-2-8-6. They're available 24 hours a day to help you.";
  ttsSpeak(supportMsg, 'normal');
  
  if (confirm("ğŸ“ Call EasyATM Support now?\n1800-EASYATM (1800-327-9286)")) {
    window.location.href = "tel:18003279286";
  }
}

function closeModal(modalId) {
  const modal = document.getElementById(modalId);
  if (modal) {
    modal.classList.remove('show');
    modal.setAttribute('aria-hidden', 'true');
  }
}

// Enhanced keyboard support
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    // Close modals
    document.querySelectorAll('.dialog.show').forEach(modal => {
      modal.classList.remove('show');
      modal.setAttribute('aria-hidden', 'true');
    });
  }
  
  // Quick help
  if (e.key === 'F1') {
    e.preventDefault();
    explainPayNow();
  }
});

console.log("ğŸ¯ EasyATM PayNow (Elderly-Optimized) Loaded Successfully!");
</script>
</body>
</html>