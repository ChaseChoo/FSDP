<!DOCTYPE html>
<html class="light" lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>OCBC ATM - Bill Scanner</title>

<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>

<!-- Tesseract.js for OCR -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>

<script id="tailwind-config">
tailwind.config = {
  darkMode: "class",
  theme: {
    extend: {
      colors: {
        primary: "#ea2a33",
        "background-light": "#f8f6f6",
        "background-dark": "#211111",
      },
      fontFamily: { display: ["Public Sans", "sans-serif"] },
      borderRadius: { DEFAULT: "0.25rem", lg: "0.5rem", xl: "0.75rem", full: "9999px" },
    }
  }
}
</script>

<style>
.material-symbols-outlined {
  font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
  font-size: 32px;
}

/* Elderly-Friendly UI Styles */
.large-button {
  font-size: 1.25rem;
  padding: 1.5rem 2rem;
  font-weight: 700;
  min-height: 80px;
}

.extra-large-text {
  font-size: 1.5rem;
  line-height: 2rem;
}

.camera-view {
  border: 4px solid #ea2a33;
  border-radius: 12px;
  overflow: hidden;
  background: #000;
}

.scan-overlay {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 80%;
  height: 60%;
  border: 3px dashed #ea2a33;
  border-radius: 8px;
  pointer-events: none;
}

.result-card {
  background: white;
  border: 3px solid #ea2a33;
  border-radius: 12px;
  padding: 2rem;
  margin: 1rem 0;
}

.result-label {
  font-size: 1.125rem;
  font-weight: 700;
  color: #666;
  margin-bottom: 0.5rem;
}

.result-value {
  font-size: 1.75rem;
  font-weight: 800;
  color: #1b0e0e;
}

.loading-spinner {
  border: 4px solid #f3f3f3;
  border-top: 4px solid #ea2a33;
  border-radius: 50%;
  width: 50px;
  height: 50px;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.hidden {
  display: none;
}
</style>
</head>

<body class="bg-background-light dark:bg-background-dark font-display text-[#1b0e0e] dark:text-white min-h-screen flex flex-col">

<!-- Header -->
<header class="w-full bg-white dark:bg-zinc-900 border-b border-[#f3e7e8] dark:border-zinc-800 px-6 lg:px-12 py-4 sticky top-0 z-50">
<div class="max-w-[1400px] mx-auto flex items-center justify-between">
<div class="flex items-center gap-3">
<img src="sources/logo_ocbc.png" alt="OCBC Logo" class="h-8">
<h1 class="text-xl font-bold hidden sm:block">Bill / Receipt Scanner</h1>
</div>
<div class="flex items-center gap-3">
<button id="backBtn" class="bg-zinc-200 dark:bg-zinc-700 text-[#1b0e0e] dark:text-white px-6 py-2 rounded-lg font-bold text-sm flex items-center gap-2 hover:bg-zinc-300 dark:hover:bg-zinc-600 transition-colors">
<span class="material-symbols-outlined !text-lg">arrow_back</span> Back
</button>
</div>
</div>
</header>

<main class="flex-1 flex flex-col max-w-[1400px] mx-auto w-full px-6 py-8">

<!-- Initial Screen -->
<div id="initialScreen" class="flex flex-col items-center justify-center space-y-6">
<div class="text-center mb-6">
<h2 class="text-3xl md:text-4xl font-extrabold mb-4 text-[#1b0e0e] dark:text-zinc-100">
Scan Your Bill or Receipt
</h2>
<p class="text-xl text-zinc-600 dark:text-zinc-400 font-medium max-w-2xl mx-auto">
Our smart scanner will extract payment details automatically. Point your camera at the bill and we'll do the rest!
</p>
</div>

<div class="grid grid-cols-1 md:grid-cols-2 gap-6 w-full max-w-4xl">
<button id="startCameraBtn" class="large-button transaction-card group relative flex flex-col items-center justify-center bg-primary text-white rounded-xl shadow-lg hover:shadow-2xl hover:bg-red-700 transition-all">
<span class="material-symbols-outlined mb-3" style="font-size: 48px;">photo_camera</span>
<span>Start Camera</span>
</button>

<button id="uploadImageBtn" class="large-button transaction-card group relative flex flex-col items-center justify-center bg-white dark:bg-zinc-900 border-4 border-primary text-primary rounded-xl shadow-lg hover:shadow-2xl hover:bg-primary/5 transition-all">
<span class="material-symbols-outlined mb-3" style="font-size: 48px;">upload_file</span>
<span>Upload Image</span>
</button>
</div>

<input type="file" id="fileInput" accept="image/*" class="hidden">
</div>

<!-- Camera Screen -->
<div id="cameraScreen" class="hidden space-y-6">
<div class="text-center mb-4">
<h2 class="text-2xl md:text-3xl font-extrabold mb-2 text-[#1b0e0e] dark:text-zinc-100">
Position Your Bill in Frame
</h2>
<p class="text-lg text-zinc-600 dark:text-zinc-400 font-medium">
Align the bill within the red box for best results
</p>
</div>

<div class="relative max-w-3xl mx-auto">
<video id="video" autoplay playsinline class="camera-view w-full"></video>
<div class="scan-overlay"></div>
<canvas id="canvas" class="hidden"></canvas>
</div>

<div class="flex justify-center gap-4">
<button id="captureBtn" class="large-button bg-primary text-white rounded-xl shadow-lg hover:shadow-2xl hover:bg-red-700 transition-all flex items-center gap-3">
<span class="material-symbols-outlined" style="font-size: 36px;">camera</span>
<span>Capture Image</span>
</button>

<button id="cancelCameraBtn" class="large-button bg-zinc-200 dark:bg-zinc-700 text-[#1b0e0e] dark:text-white rounded-xl shadow-lg hover:shadow-2xl hover:bg-zinc-300 dark:hover:bg-zinc-600 transition-all flex items-center gap-3">
<span class="material-symbols-outlined" style="font-size: 36px;">close</span>
<span>Cancel</span>
</button>
</div>
</div>

<!-- Processing Screen -->
<div id="processingScreen" class="hidden flex flex-col items-center justify-center space-y-6">
<div class="loading-spinner"></div>
<h2 class="text-2xl md:text-3xl font-extrabold text-[#1b0e0e] dark:text-zinc-100">
Processing Your Image...
</h2>
<p class="text-xl text-zinc-600 dark:text-zinc-400 font-medium">
Our AI is extracting bill information
</p>
<div id="progressText" class="text-lg text-zinc-500 font-medium"></div>
</div>

<!-- Results Screen -->
<div id="resultsScreen" class="hidden space-y-6">
<div class="text-center mb-6">
<h2 class="text-2xl md:text-3xl font-extrabold mb-2 text-[#1b0e0e] dark:text-zinc-100">
Scan Complete!
</h2>
<p class="text-lg text-zinc-600 dark:text-zinc-400 font-medium">
Review the extracted information below
</p>
</div>

<!-- Captured Image Preview -->
<div class="max-w-2xl mx-auto">
<img id="capturedImage" src="" alt="Captured bill" class="w-full rounded-xl border-4 border-primary shadow-lg">
</div>

<!-- Extracted Information Cards -->
<div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-4xl mx-auto">
<div class="result-card">
<div class="result-label">Document Type</div>
<div class="result-value" id="docType">-</div>
</div>

<div class="result-card">
<div class="result-label">Amount</div>
<div class="result-value text-primary" id="amount">-</div>
</div>

<div class="result-card md:col-span-2">
<div class="result-label">Reference Number</div>
<div class="result-value" id="refNumber">-</div>
</div>
</div>

<!-- Raw Text Section (Collapsible) -->
<div class="max-w-4xl mx-auto">
<button id="toggleRawText" class="w-full text-left px-6 py-4 bg-zinc-100 dark:bg-zinc-800 rounded-xl font-bold text-lg hover:bg-zinc-200 dark:hover:bg-zinc-700 transition-colors flex items-center justify-between">
<span>View Full Extracted Text</span>
<span class="material-symbols-outlined">expand_more</span>
</button>
<div id="rawTextContent" class="hidden mt-2 p-6 bg-white dark:bg-zinc-900 border-2 border-zinc-300 dark:border-zinc-700 rounded-xl">
<div class="result-label mb-2">Raw OCR Output</div>
<pre id="rawText" class="text-sm text-zinc-700 dark:text-zinc-300 whitespace-pre-wrap font-mono overflow-x-auto"></pre>
</div>
</div>

<!-- Action Buttons -->
<div class="flex flex-col sm:flex-row justify-center gap-4">
<button id="proceedPaymentBtn" class="large-button bg-primary text-white rounded-xl shadow-lg hover:shadow-2xl hover:bg-red-700 transition-all flex items-center justify-center gap-3">
<span class="material-symbols-outlined" style="font-size: 36px;">payment</span>
<span>Proceed to Payment</span>
</button>

<button id="scanAnotherBtn" class="large-button bg-white dark:bg-zinc-900 border-4 border-primary text-primary rounded-xl shadow-lg hover:shadow-2xl hover:bg-primary/5 transition-all flex items-center justify-center gap-3">
<span class="material-symbols-outlined" style="font-size: 36px;">refresh</span>
<span>Scan Another</span>
</button>
</div>
</div>

<!-- Error Screen -->
<div id="errorScreen" class="hidden flex flex-col items-center justify-center space-y-6">
<div class="text-center">
<span class="material-symbols-outlined text-primary mb-4" style="font-size: 72px;">error</span>
<h2 class="text-2xl md:text-3xl font-extrabold mb-4 text-[#1b0e0e] dark:text-zinc-100">
Oops! Something Went Wrong
</h2>
<p id="errorMessage" class="text-xl text-zinc-600 dark:text-zinc-400 font-medium max-w-2xl mx-auto mb-8">
We couldn't process your image. Please try again.
</p>
</div>

<div class="flex flex-col sm:flex-row gap-4">
<button id="retryBtn" class="large-button bg-primary text-white rounded-xl shadow-lg hover:shadow-2xl hover:bg-red-700 transition-all flex items-center gap-3">
<span class="material-symbols-outlined" style="font-size: 36px;">refresh</span>
<span>Try Again</span>
</button>

<button id="backToHomeBtn" class="large-button bg-zinc-200 dark:bg-zinc-700 text-[#1b0e0e] dark:text-white rounded-xl shadow-lg hover:shadow-2xl hover:bg-zinc-300 dark:hover:bg-zinc-600 transition-all flex items-center gap-3">
<span class="material-symbols-outlined" style="font-size: 36px;">home</span>
<span>Back to Home</span>
</button>
</div>
</div>

</main>

<script>
/**
 * Bill Scanner Module
 * Handles camera access, image capture, OCR processing, and data extraction
 */

// Global variables
let videoStream = null;
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

// Screen elements
const screens = {
  initial: document.getElementById('initialScreen'),
  camera: document.getElementById('cameraScreen'),
  processing: document.getElementById('processingScreen'),
  results: document.getElementById('resultsScreen'),
  error: document.getElementById('errorScreen')
};

// Button elements
const buttons = {
  startCamera: document.getElementById('startCameraBtn'),
  uploadImage: document.getElementById('uploadImageBtn'),
  capture: document.getElementById('captureBtn'),
  cancelCamera: document.getElementById('cancelCameraBtn'),
  scanAnother: document.getElementById('scanAnotherBtn'),
  retry: document.getElementById('retryBtn'),
  back: document.getElementById('backBtn'),
  backToHome: document.getElementById('backToHomeBtn'),
  proceedPayment: document.getElementById('proceedPaymentBtn'),
  toggleRawText: document.getElementById('toggleRawText')
};

// File input
const fileInput = document.getElementById('fileInput');

/**
 * Show a specific screen and hide others
 * @param {string} screenName - Name of the screen to show
 */
function showScreen(screenName) {
  Object.values(screens).forEach(screen => screen.classList.add('hidden'));
  if (screens[screenName]) {
    screens[screenName].classList.remove('hidden');
  }
}

/**
 * Initialize and start camera
 */
async function startCamera() {
  try {
    // Request camera access with high resolution for better OCR
    videoStream = await navigator.mediaDevices.getUserMedia({
      video: {
        facingMode: 'environment', // Use back camera on mobile
        width: { ideal: 1920 },
        height: { ideal: 1080 }
      }
    });
    
    video.srcObject = videoStream;
    showScreen('camera');
  } catch (error) {
    console.error('Camera access error:', error);
    showError('Unable to access camera. Please check permissions and try again.');
  }
}

/**
 * Stop camera stream
 */
function stopCamera() {
  if (videoStream) {
    videoStream.getTracks().forEach(track => track.stop());
    videoStream = null;
  }
}

/**
 * Capture image from video stream
 */
function captureImage() {
  // Set canvas dimensions to match video
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  
  // Draw current video frame to canvas
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  
  // Convert canvas to blob and process
  canvas.toBlob(blob => {
    processImage(blob);
  }, 'image/jpeg', 0.95);
  
  stopCamera();
}

/**
 * Handle file upload
 */
function handleFileUpload(event) {
  const file = event.target.files[0];
  if (file && file.type.startsWith('image/')) {
    processImage(file);
  } else {
    showError('Please select a valid image file.');
  }
  // Reset file input
  event.target.value = '';
}

/**
 * Process image with Tesseract OCR
 * @param {Blob|File} imageBlob - Image to process
 */
async function processImage(imageBlob) {
  showScreen('processing');
  
  try {
    // Create object URL for image preview
    const imageUrl = URL.createObjectURL(imageBlob);
    document.getElementById('capturedImage').src = imageUrl;
    
    // Initialize Tesseract worker
    const progressText = document.getElementById('progressText');
    progressText.textContent = 'Initializing OCR engine...';
    
    const worker = await Tesseract.createWorker({
      logger: m => {
        // Update progress text
        if (m.status === 'recognizing text') {
          const progress = Math.round(m.progress * 100);
          progressText.textContent = `Recognizing text: ${progress}%`;
        }
      }
    });
    
    await worker.loadLanguage('eng');
    await worker.initialize('eng');
    
    // Perform OCR
    progressText.textContent = 'Extracting text...';
    const { data: { text } } = await worker.recognize(imageBlob);
    
    // Clean up worker
    await worker.terminate();
    
    // Extract information from OCR text
    extractInformation(text);
    
    showScreen('results');
    
  } catch (error) {
    console.error('OCR processing error:', error);
    showError('Failed to process image. Please ensure the image is clear and try again.');
  }
}

/**
 * Extract key information from OCR text using regex
 * @param {string} text - Raw OCR text
 */
function extractInformation(text) {
  // Display raw text
  document.getElementById('rawText').textContent = text;
  
  // Extract document type
  const docType = detectDocumentType(text);
  document.getElementById('docType').textContent = docType;
  
  // Extract amount
  const amount = extractAmount(text);
  document.getElementById('amount').textContent = amount || 'Not found';
  
  // Extract reference number
  const refNumber = extractReferenceNumber(text);
  document.getElementById('refNumber').textContent = refNumber || 'Not found';
}

/**
 * Detect document type from text
 * @param {string} text - OCR text
 * @returns {string} Document type
 */
function detectDocumentType(text) {
  const lowerText = text.toLowerCase();
  
  if (lowerText.includes('invoice')) {
    return 'Invoice';
  } else if (lowerText.includes('receipt')) {
    return 'Receipt';
  } else if (lowerText.includes('bill')) {
    return 'Bill';
  } else if (lowerText.includes('statement')) {
    return 'Statement';
  } else {
    return 'Document';
  }
}

/**
 * Extract amount from text using regex patterns
 * @param {string} text - OCR text
 * @returns {string|null} Extracted amount
 */
function extractAmount(text) {
  // Patterns for different currency formats
  const patterns = [
    // SGD 123.45 or S$123.45
    /(?:SGD|S\$|SGD\s*\$)\s*(\d{1,3}(?:,\d{3})*(?:\.\d{2})?)/gi,
    // $123.45
    /\$\s*(\d{1,3}(?:,\d{3})*(?:\.\d{2})?)/g,
    // Total: 123.45 or Amount: 123.45
    /(?:total|amount|pay|due)[\s:]*\$?\s*(\d{1,3}(?:,\d{3})*(?:\.\d{2})?)/gi,
    // Plain number with 2 decimal places (likely an amount)
    /\b(\d{1,3}(?:,\d{3})*\.\d{2})\b/g
  ];
  
  for (const pattern of patterns) {
    const matches = [...text.matchAll(pattern)];
    if (matches.length > 0) {
      // Return the largest amount found (likely the total)
      const amounts = matches.map(m => {
        const numStr = m[1].replace(/,/g, '');
        return {
          value: parseFloat(numStr),
          original: m[0]
        };
      });
      
      amounts.sort((a, b) => b.value - a.value);
      return `S$${amounts[0].value.toFixed(2)}`;
    }
  }
  
  return null;
}

/**
 * Extract reference number from text
 * @param {string} text - OCR text
 * @returns {string|null} Extracted reference number
 */
function extractReferenceNumber(text) {
  // Patterns for reference numbers
  const patterns = [
    // Ref: ABC123, Reference: ABC123
    /(?:ref(?:erence)?|transaction|invoice|bill|receipt)[\s#:]*([A-Z0-9-]{5,})/gi,
    // #ABC123
    /#([A-Z0-9-]{5,})/g,
    // Generic alphanumeric codes (at least 6 characters)
    /\b([A-Z]{2,}\d{4,}|\d{4,}[A-Z]{2,})\b/g
  ];
  
  for (const pattern of patterns) {
    const match = text.match(pattern);
    if (match) {
      // Clean up the match
      let refNum = match[0].replace(/^(ref|reference|transaction|invoice|bill|receipt)[\s#:]*/gi, '');
      refNum = refNum.replace(/^#/, '');
      return refNum.trim().toUpperCase();
    }
  }
  
  return null;
}

/**
 * Show error screen with message
 * @param {string} message - Error message to display
 */
function showError(message) {
  document.getElementById('errorMessage').textContent = message;
  showScreen('error');
  stopCamera();
}

/**
 * Reset to initial screen
 */
function resetToInitial() {
  stopCamera();
  showScreen('initial');
}

// Event Listeners

// Start camera button
buttons.startCamera.addEventListener('click', startCamera);

// Upload image button
buttons.uploadImage.addEventListener('click', () => {
  fileInput.click();
});

// File input change
fileInput.addEventListener('change', handleFileUpload);

// Capture button
buttons.capture.addEventListener('click', captureImage);

// Cancel camera button
buttons.cancelCamera.addEventListener('click', resetToInitial);

// Scan another button
buttons.scanAnother.addEventListener('click', resetToInitial);

// Retry button
buttons.retry.addEventListener('click', resetToInitial);

// Back buttons
buttons.back.addEventListener('click', () => {
  window.location.href = 'home.html';
});

buttons.backToHome.addEventListener('click', () => {
  window.location.href = 'home.html';
});

// Proceed to payment button
buttons.proceedPayment.addEventListener('click', () => {
  const amount = document.getElementById('amount').textContent;
  const refNumber = document.getElementById('refNumber').textContent;
  
  // Store data in sessionStorage for use in payment page
  sessionStorage.setItem('billAmount', amount);
  sessionStorage.setItem('billReference', refNumber);
  
  // Redirect to bills payment page
  window.location.href = 'bills.html';
});

// Toggle raw text visibility
buttons.toggleRawText.addEventListener('click', () => {
  const content = document.getElementById('rawTextContent');
  const icon = buttons.toggleRawText.querySelector('.material-symbols-outlined');
  
  if (content.classList.contains('hidden')) {
    content.classList.remove('hidden');
    icon.textContent = 'expand_less';
  } else {
    content.classList.add('hidden');
    icon.textContent = 'expand_more';
  }
});

// Clean up on page unload
window.addEventListener('beforeunload', () => {
  stopCamera();
});

// Initialize on page load
console.log('Bill Scanner initialized');
</script>

</body>
</html>
