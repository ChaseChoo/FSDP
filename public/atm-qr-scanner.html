<!DOCTYPE html>
<html class="light" lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OCBC ATM - Guardian QR Scanner</title>
  
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <link href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
  <script id="tailwind-config">
  tailwind.config = {
    darkMode: "class",
    theme: {
      extend: {
        colors: {
          primary: "#ea2a33",
          "background-light": "#f8f6f6",
          "background-dark": "#211111",
        },
        fontFamily: { display: ["Public Sans", "sans-serif"] },
        borderRadius: { DEFAULT: "0.25rem", lg: "0.5rem", xl: "0.75rem", full: "9999px" },
      }
    }
  }
  </script>
  <style type="text/tailwindcss">
    .material-symbols-outlined {
      font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
      font-size: 32px;
    }
    body {
      background-image: linear-gradient(rgba(248, 246, 246, 0.98), rgba(248, 246, 246, 0.7)), url('sources/pexels-realcereal-15480508.jpg');
      background-attachment: fixed;
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
    }
    #reader {
      border-radius: 12px;
      overflow: hidden;
    }
  </style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display text-[#1b0e0e] dark:text-white h-screen flex flex-col overflow-hidden">
<header class="w-full bg-white dark:bg-zinc-900 border-b border-[#f3e7e8] dark:border-zinc-800 px-6 lg:px-12 py-4 sticky top-0 z-50 shadow-sm">
  <div class="max-w-[1400px] mx-auto flex items-center justify-between">
    <div class="flex items-center gap-3">
      <a href="home.html" class="cursor-pointer">
        <img src="sources/logo_ocbc.png" alt="OCBC Logo" class="h-8 hover:opacity-80 transition-opacity">
      </a>
    </div>
    <div class="flex items-center gap-3">
      <button onclick="goBack()" class="bg-primary text-white px-6 py-2 rounded-lg font-bold text-sm flex items-center gap-2 hover:bg-red-700 transition-colors">
        <span class="material-symbols-outlined !text-lg">arrow_back</span> Back to Home
      </button>
    </div>
  </div>
</header>

<main class="flex-1 flex flex-col max-w-[1000px] mx-auto w-full px-6 py-8 overflow-y-auto">
  
  <div class="mb-8">
    <h1 class="text-4xl font-extrabold mb-3 text-[#1b0e0e] dark:text-zinc-100 tracking-tight">Guardian QR Scanner</h1>
    <p class="text-zinc-600 dark:text-zinc-400 text-lg">Position the QR code in front of the camera</p>
  </div>

  <div id="statusMessage" class="hidden mb-6"></div>

  <div id="cameraContainer" class="hidden mb-6">
    <div class="bg-black rounded-2xl overflow-hidden shadow-xl border-4 border-white">
      <div id="reader"></div>
    </div>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
    <button id="startBtn" onclick="startScanning()" class="bg-primary hover:bg-red-700 text-white font-bold py-4 px-6 rounded-xl shadow-lg hover:shadow-xl transition-all flex items-center justify-center gap-3">
      <span class="material-symbols-outlined">videocam</span>
      <span>Start Camera</span>
    </button>
    <button id="stopBtn" onclick="stopScanning()" class="hidden bg-zinc-200 hover:bg-zinc-300 text-zinc-700 font-bold py-4 px-6 rounded-xl shadow-lg hover:shadow-xl transition-all flex items-center justify-center gap-3">
      <span class="material-symbols-outlined">videocam_off</span>
      <span>Stop Camera</span>
    </button>
  </div>

  <div id="transactionDetails" class="hidden bg-white dark:bg-zinc-900 rounded-2xl shadow-xl border-2 border-transparent p-8">
    <div class="flex items-center gap-3 mb-6">
      <div class="bg-primary/10 p-3 rounded-xl">
        <span class="material-symbols-outlined text-primary">receipt_long</span>
      </div>
      <h3 class="text-2xl font-bold text-[#1b0e0e] dark:text-zinc-100">Guardian Transaction</h3>
    </div>
    <div id="detailsContent" class="mb-6"></div>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <button onclick="executeTransaction()" class="bg-primary hover:bg-red-700 text-white font-bold py-4 px-6 rounded-xl shadow-lg hover:shadow-xl transition-all flex items-center justify-center gap-3">
        <span class="material-symbols-outlined">check_circle</span>
        <span>Confirm & Execute</span>
      </button>
      <button onclick="cancelTransaction()" class="bg-zinc-200 hover:bg-zinc-300 text-zinc-700 font-bold py-4 px-6 rounded-xl shadow-lg hover:shadow-xl transition-all flex items-center justify-center gap-3">
        <span class="material-symbols-outlined">cancel</span>
        <span>Cancel</span>
      </button>
    </div>
  </div>

</main>

  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <script>
    let html5QrCode;
    let currentActionData = null;

    function showStatus(message, type = 'info') {
      const statusDiv = document.getElementById('statusMessage');
      statusDiv.textContent = message;
      statusDiv.className = `px-6 py-4 rounded-xl font-medium text-sm shadow-lg mb-6 ${
        type === 'success' ? 'bg-green-50 text-green-800 border-2 border-green-200' :
        type === 'error' ? 'bg-red-50 text-red-800 border-2 border-red-200' :
        'bg-blue-50 text-blue-800 border-2 border-blue-200'
      }`;
      statusDiv.classList.remove('hidden');
    }

    function hideStatus() {
      document.getElementById('statusMessage').classList.add('hidden');
    }

    async function startScanning() {
      try {
        html5QrCode = new Html5Qrcode("reader");
        document.getElementById('cameraContainer').classList.remove('hidden');
        document.getElementById('startBtn').classList.add('hidden');
        document.getElementById('stopBtn').classList.remove('hidden');

        hideStatus();

        let cameraStarted = false;

        try {
          await html5QrCode.start(
            { facingMode: "user" },
            { fps: 10, qrbox: { width: 300, height: 300 } },
            onScanSuccess
          );
          cameraStarted = true;
        } catch (err) {
          console.log("Front camera failed, trying back camera:", err);
          
          try {
            await html5QrCode.start(
              { facingMode: "environment" },
              { fps: 10, qrbox: { width: 300, height: 300 } },
              onScanSuccess
            );
            cameraStarted = true;
          } catch (err2) {
            console.log("Back camera failed, trying first available:", err2);
            
            const cameras = await Html5Qrcode.getCameras();
            if (cameras && cameras.length > 0) {
              await html5QrCode.start(
                cameras[0].id,
                { fps: 10, qrbox: { width: 300, height: 300 } },
                onScanSuccess
              );
              cameraStarted = true;
            } else {
              throw new Error("No cameras available");
            }
          }
        }

        if (cameraStarted) {
          showStatus('Camera active - scan Guardian QR code', 'success');
        }
      } catch (err) {
        console.error("Camera error:", err);
        showStatus('Unable to access camera. Please check permissions.', 'error');
        document.getElementById('startBtn').classList.remove('hidden');
        document.getElementById('stopBtn').classList.add('hidden');
        document.getElementById('cameraContainer').classList.add('hidden');
      }
    }

    async function stopScanning() {
      if (html5QrCode) {
        try {
          await html5QrCode.stop();
        } catch (err) {
          console.log("Stop error:", err);
        }
      }
      document.getElementById('cameraContainer').classList.add('hidden');
      document.getElementById('startBtn').classList.remove('hidden');
      document.getElementById('stopBtn').classList.add('hidden');
      hideStatus();
    }

    async function onScanSuccess(decodedText, decodedResult) {
      try {
        stopScanning();

        let actionId = decodedText;

        try {
          const url = new URL(decodedText);
          const actionFromUrl = url.searchParams.get('action');
          if (actionFromUrl) {
            actionId = actionFromUrl;
          }
        } catch (e) {
          console.log("Not a URL, using as direct action ID");
        }

        console.log("Extracted actionId:", actionId);
        showStatus('QR code detected - validating...', 'info');

        const response = await fetch('/api/guardian-qr/validate-action', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ actionId }),
          credentials: 'include'
        });

        const result = await response.json();

        if (response.ok) {
          currentActionData = result.action;
          displayTransactionDetails(result.action);
          showStatus('QR code validated successfully!', 'success');
        } else {
          showStatus(result.message || 'Invalid or expired QR code', 'error');
        }
      } catch (err) {
        console.error("Scan processing error:", err);
        showStatus('Error processing QR code', 'error');
      }
    }

    function displayTransactionDetails(action) {
      const detailsDiv = document.getElementById('detailsContent');
      detailsDiv.innerHTML = `
        <div class="space-y-4">
          <div class="flex justify-between items-center py-3 border-b border-zinc-200 dark:border-zinc-700">
            <span class="text-zinc-600 dark:text-zinc-400 font-medium">Action Type</span>
            <span class="font-bold text-zinc-900 dark:text-zinc-100">${action.action}</span>
          </div>
          ${action.amount ? `
          <div class="flex justify-between items-center py-3 border-b border-zinc-200 dark:border-zinc-700">
            <span class="text-zinc-600 dark:text-zinc-400 font-medium">Amount</span>
            <span class="font-bold text-zinc-900 dark:text-zinc-100">$${action.amount.toFixed(2)}</span>
          </div>
          ` : ''}
          <div class="flex justify-between items-center py-3 border-b border-zinc-200 dark:border-zinc-700">
            <span class="text-zinc-600 dark:text-zinc-400 font-medium">Guardian</span>
            <span class="font-bold text-zinc-900 dark:text-zinc-100">${action.guardianExternalId}</span>
          </div>
          <div class="flex justify-between items-center py-3 border-b border-zinc-200 dark:border-zinc-700">
            <span class="text-zinc-600 dark:text-zinc-400 font-medium">Max Uses</span>
            <span class="font-bold text-zinc-900 dark:text-zinc-100">${action.currentUses || 0} / ${action.maxUses}</span>
          </div>
          <div class="flex justify-between items-center py-3">
            <span class="text-zinc-600 dark:text-zinc-400 font-medium">Expires</span>
            <span class="font-bold text-zinc-900 dark:text-zinc-100">${new Date(action.expiresAt).toLocaleString()}</span>
          </div>
        </div>
      `;
      document.getElementById('transactionDetails').classList.remove('hidden');
    }

    async function executeTransaction() {
      if (!currentActionData) return;

      try {
        showStatus('Processing transaction...', 'info');

        const response = await fetch('/api/guardian-qr/execute-action', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ actionId: currentActionData.id }),
          credentials: 'include'
        });

        const result = await response.json();

        if (response.ok) {
          const newBalance = result.account?.balance ?? result.transaction?.newBalance ?? 'N/A';
          showStatus(`Transaction successful! New balance: $${typeof newBalance === 'number' ? newBalance.toFixed(2) : newBalance}`, 'success');
          
          setTimeout(() => {
            window.location.href = 'home.html';
          }, 3000);
        } else {
          showStatus(result.message || 'Transaction failed', 'error');
        }
      } catch (err) {
        console.error("Transaction error:", err);
        showStatus('Error executing transaction', 'error');
      }
    }

    function cancelTransaction() {
      currentActionData = null;
      document.getElementById('transactionDetails').classList.add('hidden');
      hideStatus();
    }

    function goBack() {
      window.location.href = 'home.html';
    }
  </script>
</body>
</html>
