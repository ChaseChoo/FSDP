<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ATM - Scan Guardian QR</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="styles/home.css">
  <style>
    .scanner-container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }

    .scanner-header {
      text-align: center;
      margin-bottom: 30px;
    }

    .scanner-header h1 {
      font-size: 28px;
      color: #333;
      margin-bottom: 10px;
    }

    .scanner-header p {
      color: #666;
      font-size: 16px;
    }

    .camera-container {
      background: #000;
      border-radius: 15px;
      overflow: hidden;
      margin-bottom: 20px;
      position: relative;
    }

    #reader {
      width: 100%;
      border: none;
    }

    .scanner-controls {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-bottom: 20px;
    }

    .scanner-btn {
      padding: 12px 24px;
      font-size: 16px;
      font-weight: 600;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .scanner-btn.primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .scanner-btn.secondary {
      background: #e0e0e0;
      color: #333;
    }

    .scanner-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }

    .status-message {
      text-align: center;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
      font-weight: 500;
      display: none;
    }

    .status-message.success {
      background: #e8f5e9;
      color: #2e7d32;
    }

    .status-message.error {
      background: #ffebee;
      color: #c62828;
    }

    .status-message.info {
      background: #e3f2fd;
      color: #1565c0;
    }

    .transaction-details {
      background: white;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      display: none;
    }

    .transaction-details h3 {
      color: #333;
      margin-bottom: 15px;
      font-size: 20px;
    }

    .detail-row {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid #e0e0e0;
    }

    .detail-row:last-child {
      border-bottom: none;
    }

    .detail-label {
      color: #666;
      font-weight: 500;
    }

    .detail-value {
      color: #333;
      font-weight: 600;
    }

    .confirm-buttons {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .confirm-buttons button {
      flex: 1;
    }
  </style>
</head>
<body style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px;">
  <div class="scanner-container">
    <div class="scanner-header">
      <h1>Scan Guardian QR Code</h1>
      <p>Position the QR code from the guardian's phone in front of the camera</p>
    </div>

    <div id="statusMessage" class="status-message"></div>

    <div class="camera-container" id="cameraContainer" style="display: none;">
      <div id="reader"></div>
    </div>

    <div class="scanner-controls">
      <button id="startBtn" class="scanner-btn primary" onclick="startScanning()">Start Camera</button>
      <button id="stopBtn" class="scanner-btn secondary" onclick="stopScanning()" style="display: none;">Stop Camera</button>
      <button class="scanner-btn secondary" onclick="showManualEntry()">Manual Entry</button>
      <button class="scanner-btn secondary" onclick="goBack()">Back to Home</button>
    </div>

    <div id="manualEntrySection" style="display: none; margin-top: 20px; padding: 20px; background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
      <h3 style="margin-top: 0;">Enter Action ID Manually</h3>
      <p style="color: #666; font-size: 0.9rem;">Paste the action ID from the Guardian QR code URL</p>
      <input type="text" id="manualActionId" placeholder="Enter action ID here..." style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem; margin: 10px 0;">
      <div style="display: flex; gap: 10px;">
        <button class="scanner-btn primary" onclick="validateManualEntry()">Validate</button>
        <button class="scanner-btn secondary" onclick="hideManualEntry()">Cancel</button>
      </div>
    </div>

    <div id="transactionDetails" class="transaction-details">
      <h3>Guardian Transaction</h3>
      <div id="detailsContent"></div>
      <div class="confirm-buttons">
        <button class="scanner-btn primary" onclick="executeTransaction()">Confirm & Execute</button>
        <button class="scanner-btn secondary" onclick="cancelTransaction()">Cancel</button>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script>
    let html5QrcodeScanner = null;
    let scannedActionId = null;
    let transactionData = null;

    function showManualEntry() {
      document.getElementById('manualEntrySection').style.display = 'block';
      document.getElementById('manualActionId').focus();
    }

    function hideManualEntry() {
      document.getElementById('manualEntrySection').style.display = 'none';
      document.getElementById('manualActionId').value = '';
    }

    async function validateManualEntry() {
      const input = document.getElementById('manualActionId').value.trim();
      if (!input) {
        showStatus('Please enter an action ID', 'error');
        return;
      }

      // Extract actionId from URL if needed
      let actionId = input;
      try {
        const url = new URL(input);
        const actionParam = url.searchParams.get('action');
        if (actionParam) {
          actionId = actionParam;
          console.log('Extracted actionId from URL:', actionId);
        }
      } catch (e) {
        // Not a URL, use as-is
        console.log('Using raw value as actionId:', actionId);
      }

      scannedActionId = actionId;
      showStatus('Validating action ID...', 'info');

      try {
        const response = await fetch(`/api/guardian/validate-action/${scannedActionId}`);
        
        if (!response.ok) {
          throw new Error('Invalid or expired QR code');
        }
        
        const data = await response.json();
        transactionData = data;
        
        displayTransactionDetails(data);
        hideStatus();
        hideManualEntry();
      } catch (error) {
        console.error('Error validating action:', error);
        showStatus(error.message, 'error');
        scannedActionId = null;
      }
    }

    function showStatus(message, type = 'info') {
      const statusEl = document.getElementById('statusMessage');
      statusEl.textContent = message;
      statusEl.className = `status-message ${type}`;
      statusEl.style.display = 'block';
    }

    function hideStatus() {
      document.getElementById('statusMessage').style.display = 'none';
    }

    async function startScanning() {
      try {
        hideStatus();
        document.getElementById('cameraContainer').style.display = 'block';
        document.getElementById('startBtn').style.display = 'none';
        document.getElementById('stopBtn').style.display = 'inline-block';

        html5QrcodeScanner = new Html5Qrcode("reader");
        
        const config = {
          fps: 10,
          qrbox: { width: 250, height: 250 },
          aspectRatio: 1.0
        };

        await html5QrcodeScanner.start(
          { facingMode: "environment" },
          config,
          onScanSuccess,
          onScanError
        );

        showStatus('Camera active - scan the QR code now', 'info');
      } catch (error) {
        console.error('Error starting camera:', error);
        
        // Clean up on error
        if (html5QrcodeScanner) {
          html5QrcodeScanner = null;
        }
        
        showStatus('Camera failed to start. Please refresh and allow camera access.', 'error');
        document.getElementById('cameraContainer').style.display = 'none';
        document.getElementById('startBtn').style.display = 'inline-block';
        document.getElementById('stopBtn').style.display = 'none';
      }
    }

    async function stopScanning() {
      if (html5QrcodeScanner) {
        try {
          await html5QrcodeScanner.stop();
          html5QrcodeScanner.clear();
        } catch (error) {
          // Ignore errors when stopping (scanner might not be running)
          console.log('Scanner stop error (safe to ignore):', error);
        }
        html5QrcodeScanner = null;
      }
      document.getElementById('cameraContainer').style.display = 'none';
      document.getElementById('startBtn').style.display = 'inline-block';
      document.getElementById('stopBtn').style.display = 'none';
    }

    async function onScanSuccess(decodedText, decodedResult) {
      console.log('QR Code scanned:', decodedText);
      
      // Stop scanning immediately
      await stopScanning();
      
      // Extract actionId from URL if it's a full URL, otherwise use as-is
      let actionId = decodedText;
      try {
        const url = new URL(decodedText);
        const actionParam = url.searchParams.get('action');
        if (actionParam) {
          actionId = actionParam;
          console.log('Extracted actionId from URL:', actionId);
        }
      } catch (e) {
        // Not a URL, use decodedText as-is
        console.log('Using raw QR code value as actionId:', actionId);
      }
      
      scannedActionId = actionId;
      showStatus('QR Code detected - fetching transaction details...', 'info');
      
      // Fetch action details
      try {
        const response = await fetch(`/api/guardian/validate-action/${scannedActionId}`);
        
        if (!response.ok) {
          throw new Error('Invalid or expired QR code');
        }
        
        const data = await response.json();
        transactionData = data;
        
        displayTransactionDetails(data);
        hideStatus();
      } catch (error) {
        console.error('Error fetching action details:', error);
        showStatus(error.message, 'error');
        scannedActionId = null;
      }
    }

    function onScanError(errorMessage) {
      // Ignore scan errors (happens frequently while scanning)
    }

    function displayTransactionDetails(data) {
      const detailsContent = document.getElementById('detailsContent');
      
      // Handle both old and new response formats
      const actionType = data.action?.type || data.action;
      const guardianName = data.action?.guardianName || data.guardianExternalId || 'Guardian';
      const amount = data.action?.amount || data.amount;
      const maxUses = data.action?.maxUses || data.maxUses || 1;
      const currentUses = data.action?.currentUses || data.currentUses || 0;
      const expiresAt = data.action?.expiresAt || data.expiresAt;
      
      let html = `
        <div class="detail-row">
          <span class="detail-label">Action:</span>
          <span class="detail-value">${actionType}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Guardian:</span>
          <span class="detail-value">${guardianName}</span>
        </div>
      `;
      
      if (amount) {
        html += `
          <div class="detail-row">
            <span class="detail-label">Amount:</span>
            <span class="detail-value">$${parseFloat(amount).toFixed(2)}</span>
          </div>
        `;
      }
      
      html += `
        <div class="detail-row">
          <span class="detail-label">Uses Remaining:</span>
          <span class="detail-value">${maxUses - currentUses} of ${maxUses}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Expires:</span>
          <span class="detail-value">${new Date(expiresAt).toLocaleString()}</span>
        </div>
      `;
      
      detailsContent.innerHTML = html;
      document.getElementById('transactionDetails').style.display = 'block';
    }

    async function executeTransaction() {
      if (!scannedActionId) return;
      
      showStatus('Processing transaction...', 'info');
      document.getElementById('transactionDetails').style.display = 'none';
      
      try {
        const response = await fetch('/api/guardian/execute-action', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            actionId: scannedActionId
          })
        });
        
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Transaction failed');
        }
        
        const result = await response.json();
        
        showStatus(
          `Transaction successful! ${result.action} ${result.amount ? '$' + result.amount.toFixed(2) : ''} - New balance: $${result.newBalance.toFixed(2)}`,
          'success'
        );
        
        // Redirect to home after 3 seconds
        setTimeout(() => {
          window.location.href = 'home.html';
        }, 3000);
        
      } catch (error) {
        console.error('Transaction error:', error);
        showStatus('Transaction failed: ' + error.message, 'error');
        scannedActionId = null;
        transactionData = null;
      }
    }

    function cancelTransaction() {
      scannedActionId = null;
      transactionData = null;
      document.getElementById('transactionDetails').style.display = 'none';
      hideStatus();
    }

    function goBack() {
      window.location.href = 'home.html';
    }

    // Initialize Lucide icons
    if (window.lucide) {
      lucide.createIcons();
    }
  </script>
</body>
</html>
