<!DOCTYPE html>
<html class="light" lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>OCBC ATM - Face Enrollment</title>
  <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <link href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet" />
  <script id="tailwind-config">
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            primary: "#ea2a33",
            "background-light": "#f8f6f6",
            "background-dark": "#211111",
          },
          fontFamily: { display: ["Public Sans", "sans-serif"] },
          borderRadius: { DEFAULT: "0.25rem", lg: "0.5rem", xl: "0.75rem", full: "9999px" },
        },
      },
    };
  </script>
  <style type="text/tailwindcss">
    .material-symbols-outlined {
      font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
      font-size: 28px;
    }
    body {
      background-image: linear-gradient(rgba(248, 246, 246, 0.98), rgba(248, 246, 246, 0.7)), url('sources/pexels-realcereal-15480508.jpg');
      background-attachment: fixed;
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
    }
    #video,
    #canvas {
      transform: scaleX(-1);
    }
  </style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display text-[#1b0e0e] dark:text-white h-screen flex flex-col overflow-hidden">
  <header class="w-full bg-white dark:bg-zinc-900 border-b border-[#f3e7e8] dark:border-zinc-800 px-6 lg:px-12 py-4 sticky top-0 z-50">
    <div class="max-w-[1400px] mx-auto flex items-center justify-between">
      <div class="flex items-center gap-3">
        <a href="home.html" class="cursor-pointer">
          <img src="sources/logo_ocbc.png" alt="OCBC Logo" class="h-8 hover:opacity-80 transition-opacity" />
        </a>
      </div>
      <div class="flex items-center gap-3">
        <button class="bg-primary text-white px-6 py-2 rounded-lg font-bold text-sm flex items-center gap-2 hover:bg-red-700 transition-colors" onclick="window.location.href='login.html'">
          <span class="material-symbols-outlined !text-lg">close</span>
          Cancel
        </button>
      </div>
    </div>
  </header>

  <main class="flex-1 flex max-w-[1400px] mx-auto w-full px-6 py-4 overflow-y-auto">
    <div class="w-full">
      <!-- Title Section -->
      <div class="mb-4">
        <div class="flex items-center gap-3 mb-2">
          <span class="material-symbols-outlined text-primary !text-3xl">face</span>
          <h1 class="text-2xl font-extrabold text-[#1b0e0e] dark:text-zinc-100">Face Enrollment</h1>
        </div>
        <p class="text-sm text-zinc-500 dark:text-zinc-400 font-medium">Register your face for secure login</p>
      </div>

      <!-- Two Column Layout -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Left Column: Video & Previews -->
        <div class="space-y-4">
          <div class="bg-black rounded-2xl overflow-hidden shadow-lg relative aspect-video">
            <video id="video" width="640" height="480" autoplay muted class="w-full h-full object-cover"></video>
            <canvas id="canvas"></canvas>
            <div id="captureInfo" class="absolute bottom-3 left-1/2 -translate-x-1/2 bg-black/70 text-white px-3 py-1.5 rounded-lg text-xs font-medium">
              Position your face in the frame
            </div>
          </div>

          <div class="grid grid-cols-3 gap-3">
            <div id="preview1" class="aspect-square bg-zinc-100 dark:bg-zinc-800 rounded-xl border-2 border-zinc-300 dark:border-zinc-700 overflow-hidden relative flex items-center justify-center">
              <div class="text-3xl font-bold text-zinc-400">1</div>
            </div>
            <div id="preview2" class="aspect-square bg-zinc-100 dark:bg-zinc-800 rounded-xl border-2 border-zinc-300 dark:border-zinc-700 overflow-hidden relative flex items-center justify-center">
              <div class="text-3xl font-bold text-zinc-400">2</div>
            </div>
            <div id="preview3" class="aspect-square bg-zinc-100 dark:bg-zinc-800 rounded-xl border-2 border-zinc-300 dark:border-zinc-700 overflow-hidden relative flex items-center justify-center">
              <div class="text-3xl font-bold text-zinc-400">3</div>
            </div>
          </div>
        </div>

        <!-- Right Column: Form & Controls -->
        <div class="space-y-4">
          <div id="status" class="bg-blue-50 border-2 border-blue-200 text-blue-700 px-4 py-3 rounded-2xl flex items-center gap-3">
            <span class="material-symbols-outlined !text-xl">info</span>
            <span class="text-sm">We'll capture 3 photos of your face from different angles</span>
          </div>

          <div class="bg-white dark:bg-zinc-900 border-2 border-zinc-200 dark:border-zinc-800 rounded-2xl p-5 shadow-lg">
            <h3 class="font-bold text-[#1b0e0e] dark:text-zinc-100 mb-4 flex items-center gap-2">
              <span class="material-symbols-outlined !text-xl text-primary">person</span>
              Account Information
            </h3>
            <div class="space-y-4">
              <div>
                <label class="block font-semibold text-[#1b0e0e] dark:text-zinc-100 mb-2 text-sm">Your Name</label>
                <input type="text" id="userName" placeholder="Enter your full name" class="w-full px-3 py-2.5 border-2 border-zinc-300 dark:border-zinc-700 rounded-xl focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all dark:bg-zinc-800 text-sm" />
              </div>
              <div>
                <label class="block font-semibold text-[#1b0e0e] dark:text-zinc-100 mb-2 text-sm">Select Your Account</label>
                <select id="userAccount" class="w-full px-3 py-2.5 border-2 border-zinc-300 dark:border-zinc-700 rounded-xl focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all dark:bg-zinc-800 text-sm">
                  <option value="">-- Select Account --</option>
                  <option value="5555444433332222">Lee Jia Jun - Card ending 2222</option>
                  <option value="4444333322221111">Chase Choo - Card ending 1111</option>
                  <option value="3333222211110000">Fang Yu Xuan - Card ending 0000</option>
                  <option value="2222111100009999">David Chong - Card ending 9999</option>
                  <option value="1111000099998888">Luo Tian Rui - Card ending 8888</option>
                </select>
              </div>
            </div>
          </div>

          <div class="bg-white dark:bg-zinc-900 border-2 border-zinc-200 dark:border-zinc-800 rounded-2xl p-5 shadow-lg">
            <h3 class="font-bold text-[#1b0e0e] dark:text-zinc-100 mb-4 flex items-center gap-2">
              <span class="material-symbols-outlined !text-xl text-primary">photo_camera</span>
              Capture Controls
            </h3>
            <div class="space-y-3">
              <button id="captureBtn" class="w-full bg-primary text-white px-5 py-3 rounded-xl font-bold hover:bg-red-700 transition-all shadow-lg flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                <span class="material-symbols-outlined">camera</span>
                <span id="captureBtnText">Initializing...</span>
              </button>
              <button id="saveBtn" class="w-full bg-green-600 text-white px-5 py-3 rounded-xl font-bold hover:bg-green-700 transition-all shadow-lg flex items-center justify-center gap-2" style="display: none;">
                <span class="material-symbols-outlined">check_circle</span>
                Save & Enable Face Login
              </button>
              <button class="w-full bg-zinc-200 dark:bg-zinc-700 text-zinc-900 dark:text-white px-5 py-3 rounded-xl font-bold hover:bg-zinc-300 dark:hover:bg-zinc-600 transition-all flex items-center justify-center gap-2" onclick="window.location.href='login.html'">
                <span class="material-symbols-outlined">arrow_back</span>
                Back to Login
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <footer class="w-full py-3 px-6 flex-shrink-0 text-center text-xs text-zinc-500 border-t border-zinc-200 dark:border-zinc-800">
    <span>© 2024 OCBC Bank. All rights reserved.</span>
  </footer>

  <script>
    class FaceEnrollment {
      constructor() {
        this.video = document.getElementById('video');
        this.canvas = document.getElementById('canvas');
        this.captureBtn = document.getElementById('captureBtn');
        this.captureBtnText = document.getElementById('captureBtnText');
        this.saveBtn = document.getElementById('saveBtn');
        this.statusDiv = document.getElementById('status');
        this.captureInfo = document.getElementById('captureInfo');
        this.userName = document.getElementById('userName');
        this.userAccount = document.getElementById('userAccount');

        this.captures = [];
        this.descriptors = [];
        this.currentCapture = 0;
        this.maxCaptures = 3;

        this.init();
      }

      async init() {
        try {
          await this.loadModels();
          await this.startVideo();
          await this.startDetection();

          this.captureBtn.disabled = false;
          this.captureBtnText.textContent = 'Capture Photo 1';

          this.captureBtn.addEventListener('click', () => this.capturePhoto());
          this.saveBtn.addEventListener('click', () => this.saveFaceData());
        } catch (error) {
          console.error('Init error:', error);
          this.updateStatus('error', '❌ Error: ' + error.message);
        }
      }

      async loadModels() {
        this.updateStatus('info', '⏳ Loading AI models...');
        console.log('Starting to load models...');

        try {
          const MODEL_URL = 'https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@master/weights/';

          console.log('Loading tiny face detector...');
          await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
          console.log('Loading face landmarks...');
          await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
          console.log('Loading face recognition...');
          await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL);

          console.log('✅ All models loaded successfully');
          this.updateStatus('info', '✅ AI models loaded');
        } catch (error) {
          console.error('Model loading error:', error);
          throw new Error('Failed to load AI models. Please check your internet connection.');
        }
      }

      async startVideo() {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { width: 640, height: 480 },
        });
        this.video.srcObject = stream;

        return new Promise((resolve) => {
          this.video.onloadedmetadata = () => resolve();
        });
      }

      async startDetection() {
        const canvas = faceapi.createCanvasFromMedia(this.video);
        document.getElementById('canvas').replaceWith(canvas);
        this.canvas = canvas;

        const displaySize = { width: this.video.width, height: this.video.height };
        faceapi.matchDimensions(canvas, displaySize);

        setInterval(async () => {
          const detections = await faceapi
            .detectAllFaces(this.video, new faceapi.TinyFaceDetectorOptions())
            .withFaceLandmarks()
            .withFaceDescriptors();

          const resizedDetections = faceapi.resizeResults(detections, displaySize);

          canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);

          if (detections.length > 0) {
            faceapi.draw.drawDetections(canvas, resizedDetections);
            faceapi.draw.drawFaceLandmarks(canvas, resizedDetections);

            const confidence = detections[0].detection.score;
            this.captureInfo.textContent = `Face detected (${(confidence * 100).toFixed(1)}% confidence) - Ready to capture`;
            this.captureInfo.style.background = 'rgba(34, 197, 94, 0.85)';

            if (this.currentCapture < this.maxCaptures) {
              this.captureBtn.disabled = false;
            }
          } else {
            this.captureInfo.textContent = 'No face detected - please look at camera';
            this.captureInfo.style.background = 'rgba(239, 68, 68, 0.85)';
            this.captureBtn.disabled = true;
          }
        }, 100);
      }

      async capturePhoto() {
        if (this.currentCapture >= this.maxCaptures) return;

        const detection = await faceapi
          .detectSingleFace(this.video, new faceapi.TinyFaceDetectorOptions())
          .withFaceLandmarks()
          .withFaceDescriptor();

        if (!detection) {
          this.updateStatus('error', '❌ No face detected. Please try again.');
          return;
        }

        this.descriptors.push(Array.from(detection.descriptor));

        const captureCanvas = document.createElement('canvas');
        captureCanvas.width = this.video.videoWidth;
        captureCanvas.height = this.video.videoHeight;
        const ctx = captureCanvas.getContext('2d');
        ctx.drawImage(this.video, 0, 0);

        const imageData = captureCanvas.toDataURL('image/jpeg');
        this.captures.push(imageData);

        this.currentCapture++;
        const preview = document.getElementById(`preview${this.currentCapture}`);
        preview.innerHTML = `
          <img src="${imageData}" alt="Capture ${this.currentCapture}" class="w-full h-full object-cover" />
        `;
        preview.classList.add('border-green-400', 'border-4');
        preview.classList.remove('border-zinc-300', 'border-2');

        if (this.currentCapture < this.maxCaptures) {
          this.captureBtnText.textContent = `Capture Photo ${this.currentCapture + 1}`;
          this.updateStatus('success', `✅ Photo ${this.currentCapture} captured! ${this.maxCaptures - this.currentCapture} more to go.`);
          this.speak(`Photo ${this.currentCapture} captured`);
        } else {
          this.captureBtn.style.display = 'none';
          this.saveBtn.style.display = 'flex';
          this.updateStatus('success', '✅ All photos captured! Click "Save" to enable face login.');
          this.speak('All photos captured. You can now save your face data.');
        }
      }

      async saveFaceData() {
        const name = this.userName.value.trim();
        const cardNumber = this.userAccount.value;

        if (!name || !cardNumber) {
          this.updateStatus('error', '❌ Please enter your name and select an account.');
          return;
        }

        const faceData = {
          name: name,
          cardNumber: cardNumber,
          descriptors: this.descriptors,
          captures: this.captures,
          enrolledAt: new Date().toISOString(),
        };

        let enrolledFaces = [];
        try {
          const stored = localStorage.getItem('enrolledFaces');
          if (stored) {
            enrolledFaces = JSON.parse(stored);
          }
        } catch (e) {}

        const existingIndex = enrolledFaces.findIndex((f) => f.cardNumber === cardNumber);
        if (existingIndex >= 0) {
          enrolledFaces[existingIndex] = faceData;
        } else {
          enrolledFaces.push(faceData);
        }

        localStorage.setItem('enrolledFaces', JSON.stringify(enrolledFaces));

        this.updateStatus('success', '✅ Face data saved successfully! Redirecting to login...');
        this.speak('Face recognition enabled. You can now login with your face.');

        setTimeout(() => {
          window.location.href = 'login.html';
        }, 2500);
      }

      updateStatus(type, message) {
        if (type === 'info') {
          this.statusDiv.className = 'bg-blue-50 border-2 border-blue-200 text-blue-700 px-6 py-4 rounded-2xl flex items-center gap-3';
        } else if (type === 'success') {
          this.statusDiv.className = 'bg-green-50 border-2 border-green-200 text-green-700 px-6 py-4 rounded-2xl flex items-center gap-3';
        } else {
          this.statusDiv.className = 'bg-red-50 border-2 border-red-200 text-red-700 px-6 py-4 rounded-2xl flex items-center gap-3';
        }
        this.statusDiv.innerHTML = `<span class="material-symbols-outlined">info</span><span>${message}</span>`;
      }

      speak(text) {
        if ('speechSynthesis' in window) {
          const utterance = new SpeechSynthesisUtterance(text);
          utterance.rate = 0.9;
          window.speechSynthesis.speak(utterance);
        }
      }
    }

    // Wait for face-api library to load
    function waitForFaceApi() {
      return new Promise((resolve) => {
        if (typeof faceapi !== 'undefined') {
          resolve();
        } else {
          const checkInterval = setInterval(() => {
            if (typeof faceapi !== 'undefined') {
              clearInterval(checkInterval);
              resolve();
            }
          }, 100);
        }
      });
    }

    document.addEventListener('DOMContentLoaded', async () => {
      await waitForFaceApi();
      new FaceEnrollment();
    });
  </script>
</body>
</html>
