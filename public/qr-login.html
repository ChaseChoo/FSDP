<!DOCTYPE html>
<html class="light" lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OCBC ATM - Mobile Banking</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <link rel="stylesheet" href="styles/home.css">
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#ea2a33",
                        "background-light": "#f8f6f6",
                        "background-dark": "#211111",
                    },
                    fontFamily: {
                        "display": ["Public Sans", "sans-serif"]
                    },
                },
            },
        }
    </script>
    <style>
        body {
            font-family: "Public Sans", sans-serif;
        }
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
        
        #qr-code {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        #qr-code canvas {
            border-radius: 16px;
            border: 8px solid white;
            box-shadow: 0 10px 30px rgba(15, 23, 42, 0.12);
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #e5e7eb;
            border-top-color: #ea2a33;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark text-slate-900 dark:text-slate-100 min-h-screen flex flex-col">
<div class="relative flex h-full min-h-screen w-full flex-col group/design-root overflow-x-hidden">
<div class="layout-container flex h-full grow flex-col">

<!-- HEADER -->
<header class="w-full bg-white dark:bg-zinc-900 border-b border-[#f3e7e8] dark:border-zinc-800 px-6 lg:px-12 py-4 sticky top-0 z-50">
<div class="max-w-[1400px] mx-auto flex items-center justify-between">
<div class="flex items-center gap-3">
<a href="login.html" class="cursor-pointer">
<img src="sources/logo_ocbc.png" alt="OCBC Logo" class="h-8 hover:opacity-80 transition-opacity">
</a>
</div>
<div class="flex items-center gap-3">
<button id="backBtn" onclick="window.location.href='login.html'" class="bg-primary text-white px-6 py-2 rounded-lg font-bold text-sm flex items-center gap-2 hover:bg-red-700 transition-colors">
<span class="material-symbols-outlined !text-lg">arrow_back</span>
                    Back
                </button>
</div>
</div>
</header>

<!-- MAIN CONTENT -->
<main class="flex-1 flex flex-col items-center justify-center px-4 py-12 relative">
<div class="max-w-[700px] w-full flex flex-col items-center">
<div class="text-center mb-12">
<h1 class="text-slate-900 dark:text-white tracking-tight text-[44px] font-bold leading-tight pb-2 font-display">
Mobile Banking QR
</h1>
<h2 class="text-slate-500 dark:text-slate-400 text-lg font-medium leading-tight tracking-tight">
Scan the QR code with your OCBC mobile app
</h2>
</div>

<div class="w-full max-w-[600px] bg-white dark:bg-slate-900 rounded-3xl p-12 shadow-2xl shadow-slate-200 dark:shadow-none border border-slate-100 dark:border-slate-800 flex flex-col items-center gap-8 relative overflow-hidden">
<div class="absolute -top-24 -right-24 w-64 h-64 bg-primary/5 rounded-full"></div>

<div class="relative z-10 w-full flex flex-col items-center">
<!-- QR CODE SECTION -->
<div class="w-full bg-slate-50 dark:bg-slate-800 rounded-2xl border-2 border-slate-200 dark:border-slate-700 p-8 flex items-center justify-center mb-8">
<div id="qr-code" class="w-full"></div>
</div>

<!-- TIMER -->
<div class="flex items-center justify-center gap-3 mb-8 p-3 bg-amber-50 dark:bg-amber-900/20 rounded-lg border border-amber-200 dark:border-amber-800 w-full">
<span class="material-symbols-outlined text-amber-600">schedule</span>
<div class="text-center">
<span class="text-sm font-medium text-amber-900 dark:text-amber-200">Time remaining: </span>
<span id="time-left" class="font-bold text-amber-900 dark:text-amber-200">5:00</span>
</div>
</div>

<!-- STATUS -->
<div id="status" class="w-full px-4 py-3 rounded-lg border flex items-center gap-3 bg-blue-50 dark:bg-blue-900/20 border-blue-200 dark:border-blue-800">
<div class="loading-spinner"></div>
<span class="text-blue-900 dark:text-blue-200 text-sm font-medium">Waiting for mobile authentication...</span>
</div>

<!-- INSTRUCTIONS -->
<div class="w-full mt-8 p-6 bg-slate-50 dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700">
<div class="flex items-center gap-2 mb-4">
<span class="material-symbols-outlined text-primary text-[24px]">smartphone</span>
<h3 class="font-bold text-slate-900 dark:text-white">How to Login:</h3>
</div>
<ol class="space-y-2 text-sm text-slate-600 dark:text-slate-400">
<li><strong class="text-slate-900 dark:text-white">1.</strong> Open OCBC mobile app</li>
<li><strong class="text-slate-900 dark:text-white">2.</strong> Point your camera at the QR code</li>
<li><strong class="text-slate-900 dark:text-white">3.</strong> Approve the login request</li>
<li><strong class="text-slate-900 dark:text-white">4.</strong> You'll be logged in automatically</li>
</ol>
</div>
</div>
</div>
</div>
</main>

<!-- FOOTER -->
<footer class="p-8 flex flex-col items-center gap-6 border-t border-slate-200 dark:border-slate-800">
<div class="text-slate-400 text-xs text-center">
© 2024 OCBC Bank. All rights reserved.
</div>
</footer>

</div>
</div>

<script>
class QRLogin {
    constructor() {
        this.sessionId = this.generateSessionId();
        this.timeRemaining = 300; // 5 minutes in seconds
        this.pollInterval = null;
        this.timerInterval = null;
        
        this.init();
    }
    
    generateSessionId() {
        return 'qr_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }
    
    async init() {
        // Generate QR code
        this.generateQRCode();
        
        // Start polling for authentication
        this.startPolling();
        
        // Start countdown timer
        this.startTimer();
    }
    
    generateQRCode() {
        // Use the current page's hostname and port (works for any device accessing the page)
        const hostname = window.location.hostname;
        const port = window.location.port || '3000';
        const protocol = window.location.protocol; // http: or https:
        const baseUrl = `${protocol}//${hostname}:${port}`;
        const qrData = `${baseUrl}/mobile-auth.html?sessionId=${this.sessionId}`;
        
        console.log('Generating QR code with URL:', qrData);
        
        // Generate QR code
        new QRCode(document.getElementById('qr-code'), {
            text: qrData,
            width: 256,
            height: 256,
            colorDark: '#000000',
            colorLight: '#ffffff',
            correctLevel: QRCode.CorrectLevel.H
        });
    }
    
    startPolling() {
        // Poll every 2 seconds to check authentication status
        this.pollInterval = setInterval(async () => {
            await this.checkAuthStatus();
        }, 2000);
    }
    
    startTimer() {
        this.timerInterval = setInterval(() => {
            this.timeRemaining--;
            
            const minutes = Math.floor(this.timeRemaining / 60);
            const seconds = this.timeRemaining % 60;
            const timeLeft = document.getElementById('time-left');
            
            timeLeft.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            // Warning when less than 1 minute
            if (this.timeRemaining <= 60) {
                timeLeft.classList.add('text-red-600');
            }
            
            // Expired
            if (this.timeRemaining <= 0) {
                this.handleTimeout();
            }
        }, 1000);
    }
    
    async checkAuthStatus() {
        try {
            const response = await fetch(`api/qr-auth-status/${this.sessionId}`);
            const data = await response.json();
            
            if (data.status === 'authenticated') {
                this.handleSuccess(data);
            } else if (data.status === 'expired' || data.status === 'invalid') {
                this.handleTimeout();
            }
        } catch (error) {
            console.error('Error checking auth status:', error);
        }
    }
    
    handleSuccess(data) {
        // Stop polling and timer
        clearInterval(this.pollInterval);
        clearInterval(this.timerInterval);
        
        // Update status
        const statusDiv = document.getElementById('status');
        statusDiv.className = 'w-full px-4 py-3 rounded-lg border flex items-center gap-3 bg-green-50 dark:bg-green-900/20 border-green-200 dark:border-green-800';
        statusDiv.innerHTML = '<span class="material-symbols-outlined text-green-600">check_circle</span><span class="text-green-900 dark:text-green-200 text-sm font-medium">✅ Authentication successful!</span>';
        
        // Store token (use 'token' key to match card login)
        if (data.token) {
            localStorage.setItem('token', data.token);
            localStorage.setItem('user', JSON.stringify(data.user));
            localStorage.setItem('account', JSON.stringify(data.account));
        }
        
        // Redirect to home page
        setTimeout(() => {
            window.location.href = 'home.html';
        }, 1500);
    }
    
    handleTimeout() {
        // Stop polling and timer
        clearInterval(this.pollInterval);
        clearInterval(this.timerInterval);
        
        // Update status
        const statusDiv = document.getElementById('status');
        statusDiv.className = 'w-full px-4 py-3 rounded-lg border flex items-center gap-3 bg-red-50 dark:bg-red-900/20 border-red-200 dark:border-red-800';
        statusDiv.innerHTML = '<span class="material-symbols-outlined text-red-600">error</span><span class="text-red-900 dark:text-red-200 text-sm font-medium">QR Code expired. Please try again.</span>';
        
        // Show refresh option
        setTimeout(() => {
            if (confirm('QR Code has expired. Would you like to generate a new one?')) {
                window.location.reload();
            } else {
                window.location.href = 'login.html';
            }
        }, 2000); 
    }
}

// Initialize QR login when page loads
document.addEventListener('DOMContentLoaded', () => {
    new QRLogin();
});
</script>
</body>
</html>
