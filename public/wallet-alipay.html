<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Alipay">
  <link rel="manifest" href="/manifest.json">
  <title>Alipay - Mock Wallet</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(180deg, #1678ff 0%, #0d5ecc 100%);
      min-height: 100vh;
      padding-bottom: 80px;
    }

    .phone-container {
      max-width: 430px;
      margin: 0 auto;
      min-height: 100vh;
      background: #f5f5f5;
      position: relative;
      box-shadow: 0 0 50px rgba(0,0,0,0.3);
    }

    .status-bar {
      height: 44px;
      background: #1678ff;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      color: white;
      font-size: 14px;
    }

    .status-time {
      font-weight: 500;
    }

    .status-icons {
      display: flex;
      gap: 4px;
    }

    .app-header {
      background: linear-gradient(180deg, #1678ff 0%, #0d5ecc 100%);
      color: white;
      padding: 20px 20px 40px 20px;
    }

    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
    }

    .app-logo {
      font-size: 28px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .header-icons {
      display: flex;
      gap: 16px;
      font-size: 20px;
    }

    .wallet-card {
      background: white;
      border-radius: 20px;
      padding: 24px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .balance-section {
      text-align: center;
      margin-bottom: 20px;
    }

    .balance-label {
      font-size: 14px;
      color: #666;
      margin-bottom: 8px;
    }

    .balance-amount {
      font-size: 48px;
      font-weight: 700;
      color: #1678ff;
      margin-bottom: 4px;
      font-family: 'Courier New', monospace;
    }

    .currency {
      font-size: 24px;
      margin-right: 4px;
    }

    .balance-update {
      font-size: 12px;
      color: #999;
    }

    .exchange-rate-card {
      margin-top: 16px;
      padding: 16px;
      background: #f0f7ff;
      border-radius: 12px;
      border: 1px solid #d4e7ff;
    }

    .exchange-rate-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .exchange-rate-title {
      font-size: 13px;
      color: #666;
      font-weight: 600;
    }

    .exchange-rate-status {
      font-size: 11px;
      color: #999;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .exchange-rate-pulse {
      width: 6px;
      height: 6px;
      background: #4CAF50;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .converted-amount {
      font-size: 32px;
      font-weight: 700;
      color: #1678ff;
      margin-bottom: 8px;
      font-family: 'Courier New', monospace;
    }

    .exchange-rate-info {
      font-size: 12px;
      color: #666;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .rate-text {
      color: #999;
    }

    .wallet-actions {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-top: 24px;
      padding-top: 24px;
      border-top: 1px solid #eee;
    }

    .action-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      background: none;
      border: none;
      cursor: pointer;
      padding: 12px 8px;
      border-radius: 12px;
      transition: background 0.2s;
    }

    .action-btn:active {
      background: #f0f0f0;
    }

    .action-icon {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: linear-gradient(135deg, #1678ff 0%, #0d5ecc 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      color: white;
    }

    .action-label {
      font-size: 12px;
      color: #333;
      font-weight: 500;
    }

    .main-content {
      padding: 20px;
    }

    .section-title {
      font-size: 18px;
      font-weight: 600;
      color: #333;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .transaction-list {
      background: white;
      border-radius: 16px;
      overflow: hidden;
    }

    .transaction-item {
      padding: 16px 20px;
      border-bottom: 1px solid #f0f0f0;
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .transaction-item:last-child {
      border-bottom: none;
    }

    .transaction-icon {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: #f0f7ff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      flex-shrink: 0;
    }

    .transaction-info {
      flex: 1;
    }

    .transaction-title {
      font-size: 15px;
      font-weight: 500;
      color: #333;
      margin-bottom: 4px;
    }

    .transaction-time {
      font-size: 12px;
      color: #999;
    }

    .transaction-amount {
      font-size: 18px;
      font-weight: 600;
      color: #52c41a;
    }

    .transaction-amount.negative {
      color: #666;
    }

    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      max-width: 430px;
      width: 100%;
      height: 70px;
      background: white;
      border-top: 1px solid #eee;
      display: flex;
      justify-content: space-around;
      align-items: center;
      padding: 8px 0;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
    }

    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      color: #999;
      font-size: 22px;
      padding: 8px 20px;
      border: none;
      background: none;
      cursor: pointer;
    }

    .nav-item.active {
      color: #1678ff;
    }

    .nav-label {
      font-size: 11px;
      font-weight: 500;
    }

    .pulse-animation {
      animation: pulse 0.5s ease-in-out;
    }

    @keyframes pulse {
      0%, 100% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.05);
      }
    }

    .notification {
      position: fixed;
      top: 60px;
      left: 50%;
      transform: translateX(-50%);
      background: #52c41a;
      color: white;
      padding: 16px 24px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 500;
      box-shadow: 0 4px 12px rgba(82, 196, 26, 0.3);
      z-index: 1000;
      display: none;
      max-width: 350px;
      width: 90%;
    }

    .notification.show {
      display: block;
      animation: slideDown 0.3s ease-out;
    }

    @keyframes slideDown {
      from {
        transform: translateX(-50%) translateY(-20px);
        opacity: 0;
      }
      to {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
      }
    }

    .wallet-id-display {
      background: #f0f7ff;
      padding: 12px 16px;
      border-radius: 12px;
      margin: 16px 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .wallet-id-label {
      font-size: 13px;
      color: #666;
    }

    .wallet-id-value {
      font-size: 14px;
      font-weight: 600;
      color: #1678ff;
      font-family: monospace;
    }
  </style>
</head>
<body>
  <div class="phone-container">
    <!-- Status Bar -->
    <div class="status-bar">
      <span class="status-time" id="currentTime">9:41</span>
      <div class="status-icons">
        <span>üì∂</span>
        <span>üì°</span>
        <span>üîã</span>
      </div>
    </div>

    <!-- App Header -->
    <div class="app-header" id="appHeader">
      <div class="header-top">
        <div class="app-logo" id="appLogo">
          <img id="appIcon" src="https://logo.clearbit.com/alipay.com" alt="Alipay" style="width: 32px; height: 32px; object-fit: contain; margin-right: 8px;" onerror="this.style.display='none'">
          <span id="appName">Alipay</span>
        </div>
        <div class="header-icons">
          <span>üîç</span>
          <span>‚ûï</span>
        </div>
      </div>

      <!-- Wallet Card -->
      <div class="wallet-card">
        <div class="balance-section">
          <div class="balance-label">Account Balance</div>
          <div class="balance-amount">
            <span class="currency">S$</span><span id="walletBalance">0.00</span>
          </div>
          <div class="balance-update" id="lastUpdate">Last updated: Now</div>

          <!-- Exchange Rate Calculator -->
          <div class="exchange-rate-card" id="exchangeRateCard" style="display: none;">
            <div class="exchange-rate-header">
              <div class="exchange-rate-title" id="exchangeRateTitle">Converted Amount</div>
              <div class="exchange-rate-status">
                <div class="exchange-rate-pulse"></div>
                <span>Live</span>
              </div>
            </div>
            <div class="converted-amount">
              <span id="convertedCurrency"></span><span id="convertedBalance">0.00</span>
            </div>
            <div class="exchange-rate-info">
              <span class="rate-text">Exchange Rate: <strong id="currentRate">0.0000</strong></span>
              <span class="rate-text" id="rateUpdate">Updated now</span>
            </div>
          </div>
        </div>

        <div class="wallet-id-display">
          <span class="wallet-id-label">Wallet ID:</span>
          <span class="wallet-id-value" id="walletIdDisplay">wallet-12345</span>
        </div>

        <div class="wallet-actions">
          <button class="action-btn">
            <div class="action-icon">üí∏</div>
            <div class="action-label">Transfer</div>
          </button>
          <button class="action-btn">
            <div class="action-icon">üîÑ</div>
            <div class="action-label">Receive</div>
          </button>
          <button class="action-btn">
            <div class="action-icon">üì±</div>
            <div class="action-label">Scan</div>
          </button>
          <button class="action-btn">
            <div class="action-icon">üí≥</div>
            <div class="action-label">Cards</div>
          </button>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <div class="section-title">
        <span>üìã</span>
        <span>Recent Transactions</span>
      </div>
      <div class="transaction-list" id="transactionList">
        <div class="transaction-item" style="text-align: center; padding: 40px 20px; color: #999;">
          <div style="width: 100%;">
            <div style="font-size: 48px; margin-bottom: 8px;">üí∞</div>
            <div>No transactions yet</div>
            <div style="font-size: 12px; margin-top: 4px;">Transfers will appear here</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
      <button class="nav-item active">
        <span>üè†</span>
        <span class="nav-label">Home</span>
      </button>
      <button class="nav-item">
        <span>üí∞</span>
        <span class="nav-label">Wealth</span>
      </button>
      <button class="nav-item">
        <span>üë§</span>
        <span class="nav-label">Me</span>
      </button>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification"></div>
  </div>

  <script>
    // Initialize wallet ID and type from URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const walletId = urlParams.get('walletId') || 'wallet-12345';
    const walletType = urlParams.get('type') || 'alipay';
    
    // Wallet configuration
    const walletConfig = {
      alipay: {
        name: 'Alipay',
        icon: 'üÖ∞Ô∏è',
        color: '#1678ff',
        colorDark: '#0d5ecc',
        displayName: 'ÊîØ‰ªòÂÆù',
        currency: 'S$',
        targetCurrency: 'CNY',
        targetCurrencySymbol: '¬•',
        targetCurrencyName: 'Chinese Yuan',
        exchangeRateApi: 'SGD_CNY'
      },
      wechat: {
        name: 'Weixin Pay',
        icon: 'üí¨',
        color: '#09bb07',
        colorDark: '#078707',
        displayName: 'ÂæÆ‰ø°ÊîØ‰ªò WeChat Pay',
        currency: 'S$',
        targetCurrency: 'CNY',
        targetCurrencySymbol: '¬•',
        targetCurrencyName: 'Chinese Yuan',
        exchangeRateApi: 'SGD_CNY'
      },
      touchngo: {
        name: 'Touch n Go',
        icon: 'üîµ',
        color: '#0066cc',
        colorDark: '#004499',
        displayName: 'Touch n Go eWallet',
        currency: 'RM',
        targetCurrency: 'MYR',
        targetCurrencySymbol: 'RM',
        targetCurrencyName: 'Malaysian Ringgit',
        exchangeRateApi: 'SGD_MYR'
      },
      grabpay: {
        name: 'GrabPay',
        icon: 'üöó',
        color: '#00b14f',
        colorDark: '#008f3f',
        displayName: 'GrabPay',
        currency: 'S$'
      }
    };
    
    const config = walletConfig[walletType] || walletConfig.alipay;
    
    // Apply wallet branding
    const appIconImg = document.getElementById('appIcon');
    if (appIconImg && appIconImg.tagName === 'IMG') {
      appIconImg.src = config.logo;
      appIconImg.onerror = function() { this.style.display = 'none'; };
    }
    document.getElementById('appName').textContent = config.name;
    document.querySelector('.currency').textContent = config.currency;
    document.getElementById('walletIdDisplay').textContent = walletId;
    
    // Update header colors
    const appHeader = document.getElementById('appHeader');
    appHeader.style.background = `linear-gradient(180deg, ${config.color} 0%, ${config.colorDark} 100%)`;
    
    // Update status bar color
    document.querySelector('.status-bar').style.background = config.color;
    
    // Update balance amount color
    document.querySelector('.balance-amount').style.color = config.color;
    
    // Update wallet ID color
    document.querySelector('.wallet-id-value').style.color = config.color;
    
    // Update all action buttons and notification colors
    const style = document.createElement('style');
    style.textContent = `
      .action-icon {
        background: linear-gradient(135deg, ${config.color} 0%, ${config.colorDark} 100%) !important;
      }
      .notification {
        background: ${config.color} !important;
      }
    `;
    document.head.appendChild(style);
    
    document.getElementById('walletIdDisplay').textContent = walletId;

    let currentBalance = 0;
    let transactions = [];
    let currentExchangeRate = 1.0;
    let exchangeRateInterval = null;

    // Exchange rate configuration
    const exchangeRates = {
      SGD_CNY: 5.35,  // SGD to Chinese Yuan (approximate)
      SGD_MYR: 3.45   // SGD to Malaysian Ringgit (approximate)
    };

    // Fetch live exchange rates from API
    async function fetchExchangeRate() {
      // Show exchange rate card only for supported wallets
      if (config.targetCurrency) {
        document.getElementById('exchangeRateCard').style.display = 'block';
        document.getElementById('exchangeRateTitle').textContent = `Amount in ${config.targetCurrencyName}`;
        document.getElementById('convertedCurrency').textContent = config.targetCurrencySymbol;
      }

      if (!config.exchangeRateApi) return;

      try {
        // Try to fetch from a free exchange rate API
        // Using exchangerate-api.com (free tier: 1500 requests/month)
        const response = await fetch(`https://open.er-api.com/v6/latest/SGD`);
        
        if (response.ok) {
          const data = await response.json();
          
          if (data.rates && data.rates[config.targetCurrency]) {
            currentExchangeRate = data.rates[config.targetCurrency];
            console.log(`Live exchange rate fetched: 1 SGD = ${currentExchangeRate} ${config.targetCurrency}`);
          } else {
            // Fallback to hardcoded rates
            currentExchangeRate = exchangeRates[config.exchangeRateApi] || 1.0;
            console.log('Using fallback exchange rate');
          }
        } else {
          // Use fallback rates
          currentExchangeRate = exchangeRates[config.exchangeRateApi] || 1.0;
        }
      } catch (error) {
        console.error('Error fetching exchange rate:', error);
        // Use fallback rates
        currentExchangeRate = exchangeRates[config.exchangeRateApi] || 1.0;
      }

      // Update the UI
      updateExchangeRateDisplay();
      document.getElementById('rateUpdate').textContent = `Updated ${new Date().toLocaleTimeString()}`;
    }

    // Update the converted balance display
    function updateExchangeRateDisplay() {
      if (!config.targetCurrency) return;

      const convertedAmount = currentBalance * currentExchangeRate;
      document.getElementById('convertedBalance').textContent = convertedAmount.toFixed(2);
      document.getElementById('currentRate').textContent = currentExchangeRate.toFixed(4);
    }

    // Update time
    function updateTime() {
      const now = new Date();
      const hours = now.getHours().toString().padStart(2, '0');
      const minutes = now.getMinutes().toString().padStart(2, '0');
      document.getElementById('currentTime').textContent = `${hours}:${minutes}`;
    }
    updateTime();
    setInterval(updateTime, 60000);

    // Show notification
    function showNotification(message) {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.classList.add('show');
      
      setTimeout(() => {
        notification.classList.remove('show');
      }, 3000);
    }

    // Update balance with animation
    function updateBalance(newBalance) {
      const balanceElement = document.getElementById('walletBalance');
      const oldBalance = currentBalance;
      currentBalance = newBalance;

      // Animate balance change
      balanceElement.classList.add('pulse-animation');
      setTimeout(() => {
        balanceElement.classList.remove('pulse-animation');
      }, 500);

      // Count up animation
      const duration = 800;
      const steps = 30;
      const increment = (newBalance - oldBalance) / steps;
      let current = oldBalance;
      let step = 0;

      const interval = setInterval(() => {
        step++;
        current += increment;
        if (step >= steps) {
          current = newBalance;
          clearInterval(interval);
        }
        balanceElement.textContent = current.toFixed(2);
      }, duration / steps);

      document.getElementById('lastUpdate').textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
      
      // Update converted balance
      updateExchangeRateDisplay();
    }

    // Add transaction to list
    function addTransaction(type, amount, description) {
      const transaction = {
        id: Date.now(),
        type: type,
        amount: amount,
        description: description,
        time: new Date().toLocaleTimeString(),
        date: new Date().toLocaleDateString()
      };

      transactions.unshift(transaction);
      renderTransactions();
    }

    // Render transactions
    function renderTransactions() {
      const listElement = document.getElementById('transactionList');
      
      if (transactions.length === 0) {
        listElement.innerHTML = `
          <div class="transaction-item" style="text-align: center; padding: 40px 20px; color: #999;">
            <div style="width: 100%;">
              <div style="font-size: 48px; margin-bottom: 8px;">üí∞</div>
              <div>No transactions yet</div>
              <div style="font-size: 12px; margin-top: 4px;">Transfers will appear here</div>
            </div>
          </div>
        `;
        return;
      }

      listElement.innerHTML = transactions.map(tx => `
        <div class="transaction-item">
          <div class="transaction-icon">
            ${tx.type === 'received' ? 'üì•' : 'üì§'}
          </div>
          <div class="transaction-info">
            <div class="transaction-title">${tx.description}</div>
            <div class="transaction-time">${tx.time}</div>
          </div>
          <div class="transaction-amount ${tx.type === 'sent' ? 'negative' : ''}">
            ${tx.type === 'received' ? '+' : '-'}${config.currency}${Math.abs(tx.amount).toFixed(2)}
          </div>
        </div>
      `).join('');
    }

    // Fetch wallet balance from server
    async function fetchWalletBalance() {
      try {
        const response = await fetch(`/api/wallet/balance/${walletId}`);
        if (response.ok) {
          const data = await response.json();
          updateBalance(data.balance);
        }
      } catch (error) {
        console.error('Error fetching wallet balance:', error);
      }
    }

    // Listen for wallet updates using BroadcastChannel
    if (window.BroadcastChannel) {
      const channel = new BroadcastChannel('wallet-updates');
      channel.onmessage = (event) => {
        if (event.data.type === 'wallet-update' && event.data.walletId === walletId) {
          const amount = event.data.amount;
          const newBalance = event.data.newBalance;
          
          updateBalance(newBalance);
          addTransaction('received', amount, `ATM Transfer from ${event.data.walletType}`);
          showNotification(`‚úÖ Received ${config.currency}${amount.toFixed(2)} from ATM!`);
          
          // Play a success sound (if available)
          try {
            const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBi6B0fPTgjMGHm7A7+OZRQ0OUqnn77BfGAhBmtvyv3AoBjJ+zPPWgzcGHGu77OGVRw0PUqnn77BfGAhBmtvyv3AoBjJ+zPPWgzcGHGu77OGVRw0PUqnn77BfGAhBmtvyv3AoBjJ+zPPWgzcGHGu77OGVRw0PUqnn77BfGAhBmtvyv3AoBjJ+zPPWgzcGHGu77OGVRw0P');
            audio.play().catch(() => {});
          } catch (e) {}
        }
      };
    }

    // Poll for updates every 2 seconds (fallback for browsers without BroadcastChannel)
    setInterval(fetchWalletBalance, 2000);

    // Fetch exchange rates on load and update every 5 minutes
    fetchExchangeRate();
    setInterval(fetchExchangeRate, 300000); // 5 minutes

    // Initial load
    fetchWalletBalance();
    renderTransactions();

    // Add some demo data for testing
    setTimeout(() => {
      if (transactions.length === 0) {
        // Simulate some initial transactions
        currentBalance = 100;
        updateBalance(100);
      }
    }, 1000);
  </script>
</body>
</html>
