<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OCBC ATM - Confirm Bill Payment</title>

  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <link href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>

  <script id="tailwind-config">
  tailwind.config = {
    darkMode: "class",
    theme: {
      extend: {
        colors: {
          primary: "#ea2a33",
          "background-light": "#f8f6f6",
          "background-dark": "#211111",
        },
        fontFamily: { display: ["Public Sans", "sans-serif"] },
        borderRadius: { DEFAULT: "0.25rem", lg: "0.5rem", xl: "0.75rem", full: "9999px" },
      }
    }
  }
  </script>

  <style>
    .material-symbols-outlined {
      font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
      font-size: 32px;
    }
  </style>
</head>

<body class="bg-background-light dark:bg-background-dark font-display text-[#1b0e0e] dark:text-white min-h-screen flex flex-col">

<!-- Header -->
<header class="w-full bg-white dark:bg-zinc-900 border-b border-[#f3e7e8] dark:border-zinc-800 px-6 lg:px-12 py-4 sticky top-0 z-50">
<div class="max-w-[1400px] mx-auto flex items-center justify-between">
<div class="flex items-center gap-3">
<img src="sources/logo_ocbc.png" alt="OCBC Logo" class="h-8">
</div>
<div class="flex items-center gap-3">
<button onclick="window.location.href='home.html#noncash'" class="bg-primary/10 text-primary px-4 py-2 rounded-lg font-bold text-sm flex items-center gap-2 hover:bg-primary/20 transition-colors">
<span class="material-symbols-outlined !text-lg">arrow_back</span> Back
</button>
</div>
</div>
</header>

<main class="flex-1 flex flex-col items-center justify-center px-4 py-8">

<div class="max-w-2xl w-full space-y-8">

<!-- Title -->
<div class="text-center">
<h2 class="text-4xl md:text-5xl font-extrabold text-[#1b0e0e] dark:text-white mb-2">Final Check</h2>
<p class="text-lg text-zinc-600 dark:text-zinc-400">Review bill details before confirming payment</p>
</div>

<!-- Warning Box -->
<div class="bg-amber-50 dark:bg-amber-950/20 border-l-4 border-amber-500 px-4 py-3 rounded">
<p class="text-sm text-amber-700 dark:text-amber-300">
<strong>Please verify all details are correct.</strong> You cannot undo this payment once confirmed.
</p>
</div>

<!-- Bill Details Card -->
<div class="bg-white dark:bg-zinc-900 border-2 border-[#ea2a33] rounded-xl shadow-lg p-8 space-y-6">

<!-- Bill Type -->
<div class="pb-6 border-b border-zinc-200 dark:border-zinc-700">
<p class="text-sm text-zinc-600 dark:text-zinc-400 font-medium mb-1">Document Type</p>
<p class="text-2xl font-bold text-[#1b0e0e] dark:text-white" id="billDocType">Bill</p>
</div>

<!-- Provider -->
<div class="pb-6 border-b border-zinc-200 dark:border-zinc-700">
<p class="text-sm text-zinc-600 dark:text-zinc-400 font-medium mb-1">Biller / Provider</p>
<p class="text-xl font-bold text-[#1b0e0e] dark:text-white" id="billProvider">—</p>
</div>

<!-- Account Number -->
<div class="pb-6 border-b border-zinc-200 dark:border-zinc-700">
<p class="text-sm text-zinc-600 dark:text-zinc-400 font-medium mb-1">Account Number</p>
<p class="text-lg font-mono font-bold text-[#1b0e0e] dark:text-white" id="billAccount">—</p>
</div>

<!-- Reference Number -->
<div class="pb-6 border-b border-zinc-200 dark:border-zinc-700">
<p class="text-sm text-zinc-600 dark:text-zinc-400 font-medium mb-1">Reference Number</p>
<p class="text-lg font-mono font-bold text-[#1b0e0e] dark:text-white" id="billRef">—</p>
</div>

<!-- Amount - Large & Bold -->
<div class="bg-primary/10 dark:bg-primary/5 border-2 border-primary rounded-lg p-6 text-center">
<p class="text-sm text-zinc-600 dark:text-zinc-400 font-medium mb-2">PAYMENT AMOUNT</p>
<p class="text-5xl font-black text-primary" id="billAmount">S$0.00</p>
</div>

</div>

<!-- Balance Check -->
<div class="bg-white dark:bg-zinc-900 border-2 border-zinc-200 dark:border-zinc-700 rounded-xl p-6">
<div class="flex items-center justify-between mb-4 pb-4 border-b border-zinc-200 dark:border-zinc-700">
<span class="text-lg font-bold text-[#1b0e0e] dark:text-white">Current Balance:</span>
<span class="text-2xl font-bold text-[#1b0e0e] dark:text-white" id="currentBalance">S$0.00</span>
</div>
<div class="flex items-center justify-between">
<span class="text-lg font-bold text-[#1b0e0e] dark:text-white">After Payment:</span>
<span class="text-2xl font-bold" id="balanceAfter" style="color: #ea2a33;">S$0.00</span>
</div>
</div>

<!-- Warning if insufficient funds -->
<div class="bg-red-50 dark:bg-red-950/20 border-l-4 border-red-500 px-4 py-3 rounded hidden" id="insufficientFundsBox">
<p class="text-sm text-red-700 dark:text-red-300">
<strong>Insufficient Funds:</strong> Your account balance is not enough for this payment. Please go back and select a different option.
</p>
</div>

<!-- Action Buttons -->
<div class="flex flex-col sm:flex-row gap-4 justify-center">
<button onclick="window.location.href='bills.html'" class="px-8 py-4 bg-white dark:bg-zinc-900 border-2 border-zinc-300 dark:border-zinc-600 text-[#1b0e0e] dark:text-white font-bold rounded-lg hover:bg-zinc-100 dark:hover:bg-zinc-800 transition-colors text-lg flex items-center justify-center gap-2">
<span class="material-symbols-outlined">arrow_back</span>
Back
</button>

<button id="confirm-payment" onclick="confirmPayment()" class="px-8 py-4 bg-primary text-white font-bold rounded-lg hover:bg-red-700 transition-colors text-lg flex items-center justify-center gap-2">
<span class="material-symbols-outlined">check_circle</span>
Confirm & Pay
</button>
</div>

</div>

</main>

<!-- Footer -->
<footer class="w-full py-6 mt-auto bg-zinc-100 dark:bg-zinc-950/50 px-6">
<div class="max-w-4xl mx-auto flex flex-col md:flex-row items-center justify-between gap-4 text-zinc-500 dark:text-zinc-500 text-xs font-medium">
<div class="flex items-center gap-2">
<span class="material-symbols-outlined !text-sm">security</span>
<span>Your session is secure and encrypted. Please do not share your PIN.</span>
</div>
<div class="flex gap-6">
<a class="hover:text-primary transition-colors" href="#">Privacy Policy</a>
<a class="hover:text-primary transition-colors" href="#">Terms of Use</a>
</div>
</div>
</footer>

<!-- Flag to prevent balance API calls -->
<script>
  window.skipBalanceAPI = true;
</script>

<script src="scripts/home.js"></script>

<script>
/**
 * Load and display bill data for confirmation
 * Data comes from sessionStorage (from bills.html)
 */
let currentBillData = null;
let currentBalance = 0;

// Load data early (before DOMContentLoaded)
try {
  const billData = sessionStorage.getItem('billPaymentData');
  if (billData) {
    currentBillData = JSON.parse(billData);
  }
} catch (e) {
  console.error('Error loading bill data:', e);
  currentBillData = null;
}

/**
 * Initialize the confirmation page
 */
document.addEventListener('DOMContentLoaded', function() {
  // Get current balance from localStorage
  const balanceStr = localStorage.getItem('balance') || '1000.00';
  currentBalance = parseFloat(balanceStr);

  // If no bill data, show default message
  if (!currentBillData) {
    document.getElementById('billDocType').textContent = 'No Bill Selected';
    document.getElementById('confirm-payment').disabled = true;
    document.getElementById('confirm-payment').textContent = 'No Bill to Pay';
    return;
  }

  // Populate bill details
  const docType = currentBillData.documentType || currentBillData.docType || 'Bill';
  const provider = currentBillData.provider || currentBillData.providerName || 'Unknown';
  const account = currentBillData.accountNumber || currentBillData.account || '—';
  const refNumber = currentBillData.reference || currentBillData.referenceNumber || '—';
  
  // Parse amount
  let amountValue = 0;
  if (currentBillData.amount) {
    const amountStr = currentBillData.amount.toString().replace(/[^\d.]/g, '');
    amountValue = parseFloat(amountStr) || 0;
  }

  // Populate fields
  document.getElementById('billDocType').textContent = docType;
  document.getElementById('billProvider').textContent = provider;
  document.getElementById('billAccount').textContent = account;
  document.getElementById('billRef').textContent = refNumber;
  
  const displayAmount = `S$${amountValue.toFixed(2)}`;
  document.getElementById('billAmount').textContent = displayAmount;

  // Update balance display
  document.getElementById('currentBalance').textContent = `S$${currentBalance.toFixed(2)}`;
  
  const balanceAfter = currentBalance - amountValue;
  document.getElementById('balanceAfter').textContent = `S$${balanceAfter.toFixed(2)}`;

  // Check if sufficient funds
  const confirmBtn = document.getElementById('confirm-payment');
  if (currentBalance < amountValue) {
    document.getElementById('insufficientFundsBox').classList.remove('hidden');
    confirmBtn.disabled = true;
    confirmBtn.classList.add('opacity-50');
    confirmBtn.style.cursor = 'not-allowed';
  }
});

/**
 * Process the payment confirmation
 */
function confirmPayment() {
  if (!currentBillData) {
    alert('No bill selected. Please go back and select a bill to pay.');
    return;
  }

  // Parse amount
  let amountValue = 0;
  if (currentBillData.amount) {
    const amountStr = currentBillData.amount.toString().replace(/[^\d.]/g, '');
    amountValue = parseFloat(amountStr) || 0;
  }

  // Check balance one more time
  const liveBalance = parseFloat(localStorage.getItem('balance') || '0');
  if (liveBalance < amountValue) {
    alert('Insufficient balance. This payment cannot be processed.');
    return;
  }

  // Disable button and show processing
  const confirmBtn = document.getElementById('confirm-payment');
  confirmBtn.disabled = true;
  confirmBtn.textContent = 'Processing...';
  confirmBtn.innerHTML = '<span class="material-symbols-outlined">hourglass_bottom</span> Processing...';

  // Simulate payment processing delay
  setTimeout(function() {
    // Calculate new balance
    const previousBalance = liveBalance;
    const newBalance = liveBalance - amountValue;
    
    // Update localStorage
    localStorage.setItem('balance', newBalance.toFixed(2));

    // Record transaction
    const transaction = {
      id: 'BILL-' + Date.now(),
      type: 'Bill Payment',
      provider: currentBillData.provider || 'Bill Payment',
      accountNumber: currentBillData.accountNumber || '—',
      reference: currentBillData.reference || '—',
      amount: amountValue,
      date: new Date().toLocaleString(),
      status: 'Completed',
      balanceAfter: newBalance
    };

    let transactions = JSON.parse(localStorage.getItem('transactions') || '[]');
    transactions.unshift(transaction);
    localStorage.setItem('transactions', JSON.stringify(transactions.slice(0, 50)));

    // Dispatch event for balance update
    if (window.dispatchEvent) {
      window.dispatchEvent(new CustomEvent('balanceUpdated', { 
        detail: { newBalance: newBalance } 
      }));
    }

    // Store receipt data for receipt page
    const receiptData = {
      amount: amountValue,
      docType: currentBillData.documentType || currentBillData.docType || 'Bill',
      refNumber: currentBillData.reference || currentBillData.referenceNumber || '—',
      provider: currentBillData.provider || currentBillData.providerName || 'Bill Payment',
      account: currentBillData.accountNumber || currentBillData.account || '—',
      previousBalance: previousBalance,
      currentBalance: newBalance
    };
    sessionStorage.setItem('billPaymentData', JSON.stringify(receiptData));

    // Clear old bill data
    sessionStorage.removeItem('billAmount');
    sessionStorage.removeItem('billReference');
    sessionStorage.removeItem('billDocType');

    // Redirect to receipt page
    window.location.href = 'receipt.html';
  }, 1200);
}

// Prevent back button for security
history.pushState(null, null, location.href);
window.onpopstate = function() {
  window.location.href = 'bills.html';
};
</script>

</body>
</html>
